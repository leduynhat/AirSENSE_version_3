

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->

<!-- Mirrored from docs.espressif.com/projects/esp-idf/en/latest/api-guides/build-system.html by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 29 Feb 2020 06:27:15 GMT -->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Build System &mdash; ESP-IDF Programming Guide v4.1-dev-2071-gf91080637 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script type="text/javascript" src="../../../../../../media.readthedocs.com/javascript/readthedocs-doc-embed.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Build System (Legacy GNU Make)" href="build-system-legacy.html" />
    <link rel="prev" title="Bootloader" href="bootloader.html" /> 

<!-- RTD Extra Head -->

<!-- 
Always link to the latest version, as canonical.
http://docs.readthedocs.org/en/latest/canonical.html
-->
<link rel="canonical" href="build-system.html" />

<link rel="stylesheet" href="../../../../../../media.readthedocs.com/css/readthedocs-doc-embed.css" type="text/css" />

<script type="text/javascript" src="../_static/readthedocs-data.js"></script>

<!-- Add page-specific data, which must exist in the page js, not global -->
<script type="text/javascript">
READTHEDOCS_DATA['page'] = "api-guides/build-system"
READTHEDOCS_DATA['source_suffix'] = ".rst"
</script>

<script type="text/javascript" src="../../../../../../media.readthedocs.com/javascript/readthedocs-analytics.js"></script>

<!-- end RTD <extrahead> -->
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index-2.html" class="icon icon-home"> ESP-IDF Programming Guide
          

          
            
            <img src="../_static/espressif-logo.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
            
              <div class="version">
                latest
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="https://docs.espressif.com/projects/esp-idf/en/latest/search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../get-started/index.html">Get Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api-reference/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hw-reference/index.html">H/W Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../esp32s2.html">ESP32-S2 Preview Support</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">API Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="app_trace.html">Application Level Tracing</a></li>
<li class="toctree-l2"><a class="reference internal" href="blufi.html">BluFi</a></li>
<li class="toctree-l2"><a class="reference internal" href="bootloader.html">Bootloader</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Build System</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#concepts">Concepts</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#using-the-build-system">Using the Build System</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#idf-py">idf.py</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-cmake-directly">Using CMake Directly</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-cmake-in-an-ide">Using CMake in an IDE</a></li>
<li class="toctree-l4"><a class="reference internal" href="#setting-the-python-interpreter">Setting the Python Interpreter</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#example-project">Example Project</a></li>
<li class="toctree-l3"><a class="reference internal" href="#project-cmakelists-file">Project CMakeLists File</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#minimal-example-cmakelists">Minimal Example CMakeLists</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mandatory-parts">Mandatory Parts</a></li>
<li class="toctree-l4"><a class="reference internal" href="#optional-project-variables">Optional Project Variables</a></li>
<li class="toctree-l4"><a class="reference internal" href="#renaming-main-component">Renaming <code class="docutils literal notranslate"><span class="pre">main</span></code> component</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#component-cmakelists-files">Component CMakeLists Files</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#searching-for-components">Searching for Components</a></li>
<li class="toctree-l4"><a class="reference internal" href="#multiple-components-with-the-same-name">Multiple components with the same name</a></li>
<li class="toctree-l4"><a class="reference internal" href="#minimal-component-cmakelists">Minimal Component CMakeLists</a></li>
<li class="toctree-l4"><a class="reference internal" href="#preset-component-variables">Preset Component Variables</a></li>
<li class="toctree-l4"><a class="reference internal" href="#build-project-variables">Build/Project Variables</a></li>
<li class="toctree-l4"><a class="reference internal" href="#controlling-component-compilation">Controlling Component Compilation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#component-configuration">Component Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#preprocessor-definitions">Preprocessor Definitions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#component-requirements">Component Requirements</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#when-writing-a-component">When writing a component</a></li>
<li class="toctree-l4"><a class="reference internal" href="#example-of-component-requirements">Example of component requirements</a></li>
<li class="toctree-l4"><a class="reference internal" href="#source-file-include-directories">Source File Include Directories</a></li>
<li class="toctree-l4"><a class="reference internal" href="#main-component-requirements">Main component requirements</a></li>
<li class="toctree-l4"><a class="reference internal" href="#common-component-requirements">Common component requirements</a></li>
<li class="toctree-l4"><a class="reference internal" href="#including-components-in-the-build">Including components in the build</a></li>
<li class="toctree-l4"><a class="reference internal" href="#requirements-in-the-build-system-implementation">Requirements in the build system implementation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#overriding-parts-of-the-project">Overriding Parts of the Project</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#project-include-cmake">project_include.cmake</a></li>
<li class="toctree-l4"><a class="reference internal" href="#kconfig-projbuild">KConfig.projbuild</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#configuration-only-components">Configuration-Only Components</a></li>
<li class="toctree-l3"><a class="reference internal" href="#debugging-cmake">Debugging CMake</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#warning-on-undefined-variables">Warning On Undefined Variables</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#example-component-cmakelists">Example Component CMakeLists</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#adding-conditional-configuration">Adding conditional configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#conditions-which-depend-on-the-target">Conditions which depend on the target</a></li>
<li class="toctree-l4"><a class="reference internal" href="#source-code-generation">Source Code Generation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#embedding-binary-data">Embedding Binary Data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#code-and-data-placements">Code and Data Placements</a></li>
<li class="toctree-l4"><a class="reference internal" href="#fully-overriding-the-component-build-process">Fully Overriding The Component Build Process</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#custom-sdkconfig-defaults">Custom sdkconfig defaults</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#target-dependent-sdkconfig-defaults">Target-dependent sdkconfig defaults</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#flash-arguments">Flash arguments</a></li>
<li class="toctree-l3"><a class="reference internal" href="#building-the-bootloader">Building the Bootloader</a></li>
<li class="toctree-l3"><a class="reference internal" href="#selecting-the-target">Selecting the Target</a></li>
<li class="toctree-l3"><a class="reference internal" href="#writing-pure-cmake-components">Writing Pure CMake Components</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-third-party-cmake-projects-with-components">Using Third-Party CMake Projects with Components</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#using-esp-idf-components-from-external-libraries">Using ESP-IDF components from external libraries</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#using-prebuilt-libraries-with-components">Using Prebuilt Libraries with Components</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-esp-idf-in-custom-cmake-projects">Using ESP-IDF in Custom CMake Projects</a></li>
<li class="toctree-l3"><a class="reference internal" href="#esp-idf-cmake-build-system-api">ESP-IDF CMake Build System API</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#idf-build-commands">idf-build-commands</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cmake-build-properties">idf-build-properties</a></li>
<li class="toctree-l4"><a class="reference internal" href="#idf-component-commands">idf-component-commands</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cmake-component-properties">idf-component-properties</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#file-globbing-incremental-builds">File Globbing &amp; Incremental Builds</a></li>
<li class="toctree-l3"><a class="reference internal" href="#build-system-metadata">Build System Metadata</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#json-configuration-server">JSON Configuration Server</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#build-system-internals">Build System Internals</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#build-scripts">Build Scripts</a></li>
<li class="toctree-l4"><a class="reference internal" href="#build-process">Build Process</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#migrating-from-esp-idf-gnu-make-system">Migrating from ESP-IDF GNU Make System</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#automatic-conversion-tool">Automatic Conversion Tool</a></li>
<li class="toctree-l4"><a class="reference internal" href="#no-longer-available-in-cmake">No Longer Available in CMake</a></li>
<li class="toctree-l4"><a class="reference internal" href="#no-default-values">No Default Values</a></li>
<li class="toctree-l4"><a class="reference internal" href="#no-longer-necessary">No Longer Necessary</a></li>
<li class="toctree-l4"><a class="reference internal" href="#flashing-from-make">Flashing from make</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="build-system-legacy.html">Build System (Legacy GNU Make)</a></li>
<li class="toctree-l2"><a class="reference internal" href="console.html">Console Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="deep-sleep-stub.html">Deep Sleep Wake Stubs</a></li>
<li class="toctree-l2"><a class="reference internal" href="error-handling.html">Error Handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="esp-ble-mesh/ble-mesh-index.html">ESP-BLE-MESH</a></li>
<li class="toctree-l2"><a class="reference internal" href="mesh.html">ESP-MESH (Wi-Fi)</a></li>
<li class="toctree-l2"><a class="reference internal" href="core_dump.html">ESP32 Core Dump</a></li>
<li class="toctree-l2"><a class="reference internal" href="event-handling.html">Event Handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="external-ram.html">External SPI-connected RAM</a></li>
<li class="toctree-l2"><a class="reference internal" href="fatal-errors.html">Fatal Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security/flash-encryption.html">Flash Encryption</a></li>
<li class="toctree-l2"><a class="reference internal" href="freertos-smp.html">FreeRTOS SMP Changes</a></li>
<li class="toctree-l2"><a class="reference internal" href="general-notes.html">General Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="hlinterrupts.html">High Level Interrupts</a></li>
<li class="toctree-l2"><a class="reference internal" href="jtag-debugging/index.html">JTAG Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="linker-script-generation.html">Linker Script Generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="lwip.html">lwIP TCP/IP Stack</a></li>
<li class="toctree-l2"><a class="reference internal" href="partition-tables.html">Partition Tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="RF_calibration.html">RF Calibration</a></li>
<li class="toctree-l2"><a class="reference internal" href="romconsole.html">ROM debug console</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security/secure-boot.html">Secure Boot</a></li>
<li class="toctree-l2"><a class="reference internal" href="thread-local-storage.html">Thread Local Storage</a></li>
<li class="toctree-l2"><a class="reference internal" href="tools/index.html">Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="ulp.html">ULP Coprocessor</a></li>
<li class="toctree-l2"><a class="reference internal" href="ulp-legacy.html">ULP Coprocessor (Legacy GNU Make)</a></li>
<li class="toctree-l2"><a class="reference internal" href="unit-tests-legacy.html">Unit Testing (Legacy GNU Make)</a></li>
<li class="toctree-l2"><a class="reference internal" href="unit-tests.html">Unit Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="wifi.html">WiFi Driver</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../libraries-and-frameworks/index.html">Libraries and Frameworks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contribute/index.html">Contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="../versions.html">Versions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../resources.html">Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../COPYRIGHT.html">Copyrights</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../languages.html">语言/Languages</a></li>
<li class="toctree-l1"><a class="reference external" href="https://readthedocs.com/projects/espressif-esp-idf/downloads/">Guide Downloads</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index-2.html">ESP-IDF Programming Guide</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index-2.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">API Guides</a> &raquo;</li>
        
      <li>Build System</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/espressif/esp-idf/blob/master/docs/en/api-guides/build-system.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="build-system">
<h1>Build System<a class="headerlink" href="#build-system" title="Permalink to this headline">¶</a></h1>
<p><a class="reference external" href="https://docs.espressif.com/projects/esp-idf/zh_CN/latest/api-guides/build-system.html">[中文]</a></p>
<p>This document explains the implementation of the ESP-IDF build system and the concept of “components”. Read this document if you want to know how to organise and build a new ESP-IDF project or component.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This document describes the CMake-based build system, which is the default since ESP-IDF V4.0. ESP-IDF also supports a <a class="reference internal" href="build-system-legacy.html"><span class="doc">legacy build system based on GNU Make</span></a>, which was the default before ESP-IDF V4.0.</p>
</div>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>An ESP-IDF project can be seen as an amalgamation of a number of components.
For example, for a webserver that shows the current humidity, there could be:</p>
<ul class="simple">
<li>The ESP32 base libraries (libc, ROM bindings, etc)</li>
<li>The WiFi drivers</li>
<li>A TCP/IP stack</li>
<li>The FreeRTOS operating system</li>
<li>A webserver</li>
<li>A driver for the humidity sensor</li>
<li>Main code tying it all together</li>
</ul>
<p>ESP-IDF makes these components explicit and configurable. To do that,
when a project is compiled, the build system will look up all the
components in the ESP-IDF directories, the project directories and
(optionally) in additional custom component directories. It then
allows the user to configure the ESP-IDF project using a a text-based
menu system to customize each component. After the components in the
project are configured, the build system will compile the project.</p>
<div class="section" id="concepts">
<h3>Concepts<a class="headerlink" href="#concepts" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>A “project” is a directory that contains all the files and configuration to build a single “app” (executable), as well as additional supporting elements such as a partition table, data/filesystem partitions, and a bootloader.</li>
<li>“Project configuration” is held in a single file called <code class="docutils literal notranslate"><span class="pre">sdkconfig</span></code> in the root directory of the project. This configuration file is modified via <code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">menuconfig</span></code> to customise the configuration of the project. A single project contains exactly one project configuration.</li>
<li>An “app” is an executable which is built by ESP-IDF. A single project will usually build two apps - a “project app” (the main executable, ie your custom firmware) and a “bootloader app” (the initial bootloader program which launches the project app).</li>
<li>“components” are modular pieces of standalone code which are compiled into static libraries (.a files) and linked into an app. Some are provided by ESP-IDF itself, others may be sourced from other places.</li>
<li>“Target” is the hardware for which an application is built. At the moment, ESP-IDF supports <code class="docutils literal notranslate"><span class="pre">esp32</span></code> and <code class="docutils literal notranslate"><span class="pre">esp32s2</span></code> targets.</li>
</ul>
<p>Some things are not part of the project:</p>
<ul class="simple">
<li>“ESP-IDF” is not part of the project. Instead it is standalone, and linked to the project via the <code class="docutils literal notranslate"><span class="pre">IDF_PATH</span></code> environment variable which holds the path of the <code class="docutils literal notranslate"><span class="pre">esp-idf</span></code> directory. This allows the IDF framework to be decoupled from your project.</li>
<li>The toolchain for compilation is not part of the project. The toolchain should be installed in the system command line PATH.</li>
</ul>
</div>
</div>
<div class="section" id="using-the-build-system">
<h2>Using the Build System<a class="headerlink" href="#using-the-build-system" title="Permalink to this headline">¶</a></h2>
<div class="section" id="idf-py">
<span id="id1"></span><h3>idf.py<a class="headerlink" href="#idf-py" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">idf.py</span></code> command line tool provides a front-end for easily managing your project builds. It manages the following tools:</p>
<ul class="simple">
<li><a class="reference external" href="https://cmake.org/">CMake</a>, which configures the project to be built</li>
<li>A command line build tool (either <a class="reference external" href="https://ninja-build.org/">Ninja</a> build or <cite>GNU Make</cite>)</li>
<li><a class="reference external" href="https://github.com/espressif/esptool/#readme">esptool.py</a> for flashing ESP32.</li>
</ul>
<p>The <a class="reference internal" href="../get-started/index.html#get-started-configure"><span class="std std-ref">getting started guide</span></a> contains a brief introduction to how to set up <code class="docutils literal notranslate"><span class="pre">idf.py</span></code> to configure, build, and flash projects.</p>
<p><code class="docutils literal notranslate"><span class="pre">idf.py</span></code> should be run in an ESP-IDF “project” directory, ie one containing a <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> file. Older style projects with a Makefile will not work with <code class="docutils literal notranslate"><span class="pre">idf.py</span></code>.</p>
<p>Type <code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">--help</span></code> for a list of commands. Here are a summary of the most useful ones:</p>
<ul>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">set-target</span> <span class="pre">&lt;target&gt;</span></code> sets the target (chip) for which the project is built. See <a class="reference internal" href="#selecting-idf-target"><span class="std std-ref">Selecting the Target</span></a>.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">menuconfig</span></code> runs the “menuconfig” tool to configure the project.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">build</span></code> will build the project found in the current directory. This can involve multiple steps:</p>
<ul class="simple">
<li>Create the build directory if needed. The sub-directory <code class="docutils literal notranslate"><span class="pre">build</span></code> is used to hold build output, although this can be changed with the <code class="docutils literal notranslate"><span class="pre">-B</span></code> option.</li>
<li>Run <a class="reference external" href="https://cmake.org/">CMake</a> as necessary to configure the project and generate build files for the main build tool.</li>
<li>Run the main build tool (<a class="reference external" href="https://ninja-build.org/">Ninja</a> or <cite>GNU Make</cite>). By default, the build tool is automatically detected but it can be explicitly set by passing the <code class="docutils literal notranslate"><span class="pre">-G</span></code> option to <code class="docutils literal notranslate"><span class="pre">idf.py</span></code>.</li>
</ul>
<p>Building is incremental so if no source files or configuration has changed since the last build, nothing will be done.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">clean</span></code> will “clean” the project by deleting build output files from the build directory, forcing a “full rebuild” the next time the project is built. Cleaning doesn’t delete CMake configuration output and some other files.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">fullclean</span></code> will delete the entire “build” directory contents. This includes all CMake configuration output. The next time the project is built, CMake will configure it from scratch. Note that this option recursively deletes <em>all</em> files in the build directory, so use with care. Project configuration is not deleted.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">flash</span></code> will automatically build the project if necessary, and then flash it to an ESP32. The <code class="docutils literal notranslate"><span class="pre">-p</span></code> and <code class="docutils literal notranslate"><span class="pre">-b</span></code> options can be used to set serial port name and flasher baud rate, respectively.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">monitor</span></code> will display serial output from the ESP32. The <code class="docutils literal notranslate"><span class="pre">-p</span></code> option can be used to set the serial port name. Type <code class="docutils literal notranslate"><span class="pre">Ctrl-]</span></code> to exit the monitor. See <a class="reference internal" href="tools/idf-monitor.html"><span class="doc">IDF Monitor</span></a> for more details about using the monitor.</p>
</li>
</ul>
<p>Multiple <code class="docutils literal notranslate"><span class="pre">idf.py</span></code> commands can be combined into one. For example, <code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">-p</span> <span class="pre">COM4</span> <span class="pre">clean</span> <span class="pre">flash</span> <span class="pre">monitor</span></code> will clean the source tree, then build the project and flash it to the ESP32 before running the serial monitor.</p>
<p>For commands that are not known to <code class="docutils literal notranslate"><span class="pre">idf.py</span></code> an attempt to execute them as a build system target will be made.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The environment variables <code class="docutils literal notranslate"><span class="pre">ESPPORT</span></code> and <code class="docutils literal notranslate"><span class="pre">ESPBAUD</span></code> can be used to set default values for the <code class="docutils literal notranslate"><span class="pre">-p</span></code> and <code class="docutils literal notranslate"><span class="pre">-b</span></code> options, respectively. Providing these options on the command line overrides the default.</p>
</div>
<div class="section" id="advanced-commands">
<span id="idf-py-size"></span><h4>Advanced Commands<a class="headerlink" href="#advanced-commands" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">app</span></code>, <code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">bootloader</span></code>, <code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">partition_table</span></code> can be used to build only the app, bootloader, or partition table from the project as applicable.</li>
<li>There are matching commands <code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">app-flash</span></code>, etc. to flash only that single part of the project to the ESP32.</li>
<li><code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">-p</span> <span class="pre">PORT</span> <span class="pre">erase_flash</span></code> will use esptool.py to erase the ESP32’s entire flash chip.</li>
<li><code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">size</span></code> prints some size information about the app. <code class="docutils literal notranslate"><span class="pre">size-components</span></code> and <code class="docutils literal notranslate"><span class="pre">size-files</span></code> are similar commands which print more detailed per-component or per-source-file information, respectively. If you define variable <code class="docutils literal notranslate"><span class="pre">-DOUTPUT_JSON=1</span></code> when running CMake (or <code class="docutils literal notranslate"><span class="pre">idf.py</span></code>), the output will be formatted as JSON not as human readable text.</li>
<li><code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">reconfigure</span></code> re-runs <a class="reference external" href="https://cmake.org/">CMake</a> even if it doesn’t seem to need re-running. This isn’t necessary during normal usage, but can be useful after adding/removing files from the source tree, or when modifying CMake cache variables. For example, <code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">-DNAME='VALUE'</span> <span class="pre">reconfigure</span></code> can be used to set variable <code class="docutils literal notranslate"><span class="pre">NAME</span></code> in CMake cache to value <code class="docutils literal notranslate"><span class="pre">VALUE</span></code>.</li>
</ul>
<p>The order of multiple <code class="docutils literal notranslate"><span class="pre">idf.py</span></code> commands on the same invocation is not important, they will automatically be executed in the correct order for everything to take effect (ie building before flashing, erasing before flashing, etc.).</p>
</div>
<div class="section" id="idf-py-options">
<h4>idf.py options<a class="headerlink" href="#idf-py-options" title="Permalink to this headline">¶</a></h4>
<p>To list all available root level options, run <code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">--help</span></code>. To list options that are specific for a subcommand, run <code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">&lt;command&gt;</span> <span class="pre">--help</span></code>, for example <code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">monitor</span> <span class="pre">--help</span></code>.
Here is a list of some useful options:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">-C</span> <span class="pre">&lt;dir&gt;</span></code> allows overriding the project directory from the default current working directory.</li>
<li><code class="docutils literal notranslate"><span class="pre">-B</span> <span class="pre">&lt;dir&gt;</span></code> allows overriding the build directory from the default <code class="docutils literal notranslate"><span class="pre">build</span></code> subdirectory of the project directory.</li>
<li><code class="docutils literal notranslate"><span class="pre">--ccache</span></code> flag can be used to enable <a class="reference external" href="https://ccache.dev/">CCache</a> when compiling source files, if the <a class="reference external" href="https://ccache.dev/">CCache</a> tool is installed. This can dramatically reduce some build times.</li>
</ul>
<p>Note that some older versions of CCache may exhibit bugs on some platforms, so if files are not rebuilt as expected then try disabling ccache and build again. CCache can be enabled by default by setting the <code class="docutils literal notranslate"><span class="pre">IDF_ENABLE_CCACHE</span></code> environment variable to a non-zero value.
- <code class="docutils literal notranslate"><span class="pre">-v</span></code> flag causes both <code class="docutils literal notranslate"><span class="pre">idf.py</span></code> and the build system to produce verbose build output. This can be useful for debugging build problems.</p>
</div>
</div>
<div class="section" id="using-cmake-directly">
<h3>Using CMake Directly<a class="headerlink" href="#using-cmake-directly" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="#idf-py"><span class="std std-ref">idf.py</span></a> is a wrapper around <a class="reference external" href="https://cmake.org/">CMake</a> for convenience. However, you can also invoke CMake directly if you prefer.</p>
<p>When <code class="docutils literal notranslate"><span class="pre">idf.py</span></code> does something, it prints each command that it runs for easy reference. For example, the <code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">build</span></code> command is the same as running these commands in a bash shell (or similar commands for Windows Command Prompt):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir -p build
<span class="nb">cd</span> build
cmake .. -G Ninja   <span class="c1"># or &#39;Unix Makefiles&#39;</span>
ninja
</pre></div>
</div>
<p>In the above list, the <code class="docutils literal notranslate"><span class="pre">cmake</span></code> command configures the project and generates build files for use with the final build tool. In this case the final build tool is <a class="reference external" href="https://ninja-build.org/">Ninja</a>: running <code class="docutils literal notranslate"><span class="pre">ninja</span></code> actually builds the project.</p>
<p>It’s not necessary to run <code class="docutils literal notranslate"><span class="pre">cmake</span></code> more than once. After the first build, you only need to run <code class="docutils literal notranslate"><span class="pre">ninja</span></code> each time. <code class="docutils literal notranslate"><span class="pre">ninja</span></code> will automatically re-invoke <code class="docutils literal notranslate"><span class="pre">cmake</span></code> if the project needs reconfiguration.</p>
<p>If using CMake with <code class="docutils literal notranslate"><span class="pre">ninja</span></code> or <code class="docutils literal notranslate"><span class="pre">make</span></code>, there are also targets for more of the <code class="docutils literal notranslate"><span class="pre">idf.py</span></code> sub-commands - for example running <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">menuconfig</span></code> or <code class="docutils literal notranslate"><span class="pre">ninja</span> <span class="pre">menuconfig</span></code> in the build directory will work the same as <code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">menuconfig</span></code>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you’re already familiar with <a class="reference external" href="https://cmake.org/">CMake</a>, you may find the ESP-IDF CMake-based build system unusual because it wraps a lot of CMake’s functionality to reduce boilerplate. See <a class="reference internal" href="#writing-pure-cmake-components">writing pure CMake components</a> for some information about writing more “CMake style” components.</p>
</div>
<div class="section" id="flashing-with-ninja-or-make">
<span id="flash-with-ninja-or-make"></span><h4>Flashing with ninja or make<a class="headerlink" href="#flashing-with-ninja-or-make" title="Permalink to this headline">¶</a></h4>
<p>It’s possible to build and flash directly from ninja or make by running a target like:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ninja flash
</pre></div>
</div>
<p>Or:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make app-flash
</pre></div>
</div>
<p>Available targets are: <code class="docutils literal notranslate"><span class="pre">flash</span></code>, <code class="docutils literal notranslate"><span class="pre">app-flash</span></code> (app only), <code class="docutils literal notranslate"><span class="pre">bootloader-flash</span></code> (bootloader only).</p>
<p>When flashing this way, optionally set the <code class="docutils literal notranslate"><span class="pre">ESPPORT</span></code> and <code class="docutils literal notranslate"><span class="pre">ESPBAUD</span></code> environment variables to specify the serial port and baud rate. You can set environment variables in your operating system or IDE project. Alternatively, set them directly on the command line:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">ESPPORT</span><span class="o">=</span>/dev/ttyUSB0 ninja flash
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Providing environment variables at the start of the command like this is Bash shell Syntax. It will work on Linux and macOS. It won’t work when using Windows Command Prompt, but it will work when using Bash-like shells on Windows.</p>
</div>
<p>Or:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make -j3 app-flash <span class="nv">ESPPORT</span><span class="o">=</span>COM4 <span class="nv">ESPBAUD</span><span class="o">=</span><span class="m">2000000</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Providing variables at the end of the command line is <code class="docutils literal notranslate"><span class="pre">make</span></code> syntax, and works for <code class="docutils literal notranslate"><span class="pre">make</span></code> on all platforms.</p>
</div>
</div>
</div>
<div class="section" id="using-cmake-in-an-ide">
<h3>Using CMake in an IDE<a class="headerlink" href="#using-cmake-in-an-ide" title="Permalink to this headline">¶</a></h3>
<p>You can also use an IDE with CMake integration. The IDE will want to know the path to the project’s <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> file. IDEs with CMake integration often provide their own build tools (CMake calls these “generators”) to build the source files as part of the IDE.</p>
<p>When adding custom non-build steps like “flash” to the IDE, it is recommended to execute <code class="docutils literal notranslate"><span class="pre">idf.py</span></code> for these “special” commands.</p>
<p>For more detailed information about integrating ESP-IDF with CMake into an IDE, see <a class="reference internal" href="#build-system-metadata">Build System Metadata</a>.</p>
</div>
<div class="section" id="setting-the-python-interpreter">
<span id="setting-python-interpreter"></span><h3>Setting the Python Interpreter<a class="headerlink" href="#setting-the-python-interpreter" title="Permalink to this headline">¶</a></h3>
<p>Currently, ESP-IDF only works with Python 2.7. If you have a system where the default <code class="docutils literal notranslate"><span class="pre">python</span></code> interpreter is Python 3.x, this can lead to problems.</p>
<p>If using <code class="docutils literal notranslate"><span class="pre">idf.py</span></code>, running <code class="docutils literal notranslate"><span class="pre">idf.py</span></code> as <code class="docutils literal notranslate"><span class="pre">python2</span> <span class="pre">$IDF_PATH/tools/idf.py</span> <span class="pre">...</span></code> will work around this issue (<code class="docutils literal notranslate"><span class="pre">idf.py</span></code> will tell other Python processes to use the same Python interpreter). You can set up a shell alias or another script to simplify the command.</p>
<p>If using CMake directly, running <code class="docutils literal notranslate"><span class="pre">cmake</span> <span class="pre">-D</span> <span class="pre">PYTHON=python2</span> <span class="pre">...</span></code> will cause CMake to override the default Python interpreter.</p>
<p>If using an IDE with CMake, setting the <code class="docutils literal notranslate"><span class="pre">PYTHON</span></code> value as a CMake cache override in the IDE UI will override the default Python interpreter.</p>
<p>To manage the Python version more generally via the command line, check out the tools <a class="reference external" href="https://github.com/pyenv/pyenv#README">pyenv</a> or <a class="reference external" href="https://virtualenv.pypa.io/en/stable/">virtualenv</a>. These let you change the default python version.</p>
</div>
</div>
<div class="section" id="example-project">
<span id="example-project-structure"></span><h2>Example Project<a class="headerlink" href="#example-project" title="Permalink to this headline">¶</a></h2>
<p>An example project directory tree might look like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>- myProject/
             - CMakeLists.txt
             - sdkconfig
             - components/ - component1/ - CMakeLists.txt
                                         - Kconfig
                                         - src1.c
                           - component2/ - CMakeLists.txt
                                         - Kconfig
                                         - src1.c
                                         - include/ - component2.h
             - main/       - CMakeLists.txt
                           - src1.c
                           - src2.c

             - build/
</pre></div>
</div>
<p>This example “myProject” contains the following elements:</p>
<ul class="simple">
<li>A top-level project CMakeLists.txt file. This is the primary file which CMake uses to learn how to build the project; and may set project-wide CMake variables. It includes the file <a class="reference external" href="https://github.com/espressif/esp-idf/blob/f91080637//tools/cmake/project.cmake">/tools/cmake/project.cmake</a> which
implements the rest of the build system. Finally, it sets the project name and defines the project.</li>
<li>“sdkconfig” project configuration file. This file is created/updated when <code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">menuconfig</span></code> runs, and holds configuration for all of the components in the project (including ESP-IDF itself). The “sdkconfig” file may or may not be added to the source control system of the project.</li>
<li>Optional “components” directory contains components that are part of the project. A project does not have to contain custom components of this kind, but it can be useful for structuring reusable code or including third party components that aren’t part of ESP-IDF. Alternatively, <code class="docutils literal notranslate"><span class="pre">EXTRA_COMPONENT_DIRS</span></code> can be set in the top-level CMakeLists.txt to look for components in other places. See the <a class="reference internal" href="#rename-main"><span class="std std-ref">renaming main</span></a> section for more info. If you have a lot of source files in your project, we recommend grouping most into components instead of putting them all in “main”.</li>
<li>“main” directory is a special component that contains source code for the project itself. “main” is a default name, the CMake variable <code class="docutils literal notranslate"><span class="pre">COMPONENT_DIRS</span></code> includes this component but you can modify this variable.</li>
<li>“build” directory is where build output is created. This directory is created by <code class="docutils literal notranslate"><span class="pre">idf.py</span></code> if it doesn’t already exist. CMake configures the project and generates interim build files in this directory. Then, after the main build process is run, this directory will also contain interim object files and libraries as well as final binary output files. This directory is usually not added to source control or distributed with the project source code.</li>
</ul>
<p>Component directories each contain a component <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> file. This file contains variable definitions
to control the build process of the component, and its integration into the overall project. See <a class="reference internal" href="#component-cmakelists-files">Component CMakeLists Files</a> for more details.</p>
<p>Each component may also include a <code class="docutils literal notranslate"><span class="pre">Kconfig</span></code> file defining the <a class="reference internal" href="#id2">component configuration</a> options that can be set via <code class="docutils literal notranslate"><span class="pre">menuconfig</span></code>. Some components may also include <code class="docutils literal notranslate"><span class="pre">Kconfig.projbuild</span></code> and <code class="docutils literal notranslate"><span class="pre">project_include.cmake</span></code> files, which are special files for <a class="reference internal" href="#overriding-parts-of-the-project">overriding parts of the project</a>.</p>
</div>
<div class="section" id="project-cmakelists-file">
<h2>Project CMakeLists File<a class="headerlink" href="#project-cmakelists-file" title="Permalink to this headline">¶</a></h2>
<p>Each project has a single top-level <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> file that contains build settings for the entire project. By default, the project CMakeLists can be quite minimal.</p>
<div class="section" id="minimal-example-cmakelists">
<h3>Minimal Example CMakeLists<a class="headerlink" href="#minimal-example-cmakelists" title="Permalink to this headline">¶</a></h3>
<p>Minimal project:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span> <span class="s">3.5</span><span class="p">)</span>
<span class="nb">include</span><span class="p">(</span><span class="o">$ENV{</span><span class="nv">IDF_PATH</span><span class="o">}</span><span class="s">/tools/cmake/project.cmake</span><span class="p">)</span>
<span class="nb">project</span><span class="p">(</span><span class="s">myProject</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="mandatory-parts">
<span id="project-mandatory-parts"></span><h3>Mandatory Parts<a class="headerlink" href="#mandatory-parts" title="Permalink to this headline">¶</a></h3>
<p>The inclusion of these three lines, in the order shown above, is necessary for every project:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">cmake_minimum_required(VERSION</span> <span class="pre">3.5)</span></code> tells CMake the minimum version that is required to build the project. ESP-IDF is designed to work with CMake 3.5 or newer. This line must be the first line in the CMakeLists.txt file.</li>
<li><code class="docutils literal notranslate"><span class="pre">include($ENV{IDF_PATH}/tools/cmake/project.cmake)</span></code> pulls in the rest of the CMake functionality to configure the project, discover all the components, etc.</li>
<li><code class="docutils literal notranslate"><span class="pre">project(myProject)</span></code> creates the project itself, and specifies the project name. The project name is used for the final binary output files of the app - ie <code class="docutils literal notranslate"><span class="pre">myProject.elf</span></code>, <code class="docutils literal notranslate"><span class="pre">myProject.bin</span></code>. Only one project can be defined per CMakeLists file.</li>
</ul>
</div>
<div class="section" id="optional-project-variables">
<h3>Optional Project Variables<a class="headerlink" href="#optional-project-variables" title="Permalink to this headline">¶</a></h3>
<p>These variables all have default values that can be overridden for custom behaviour. Look in <a class="reference external" href="https://github.com/espressif/esp-idf/blob/f91080637//tools/cmake/project.cmake">/tools/cmake/project.cmake</a> for all of the implementation details.</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">COMPONENT_DIRS</span></code>, <code class="docutils literal notranslate"><span class="pre">COMPONENTS_DIRS</span></code>: Directories to search for components. Defaults to <code class="docutils literal notranslate"><span class="pre">IDF_PATH/components</span></code>, <code class="docutils literal notranslate"><span class="pre">PROJECT_DIR/components</span></code>, and <code class="docutils literal notranslate"><span class="pre">EXTRA_COMPONENT_DIRS</span></code>. Override this variable if you don’t want to search for components in these places.</li>
<li><code class="docutils literal notranslate"><span class="pre">EXTRA_COMPONENT_DIRS</span></code>, <code class="docutils literal notranslate"><span class="pre">EXTRA_COMPONENTS_DIRS</span></code>: Optional list of additional directories to search for components. Paths can be relative to the project directory, or absolute.</li>
<li><code class="docutils literal notranslate"><span class="pre">COMPONENTS</span></code>: A list of component names to build into the project. Defaults to all components found in the <code class="docutils literal notranslate"><span class="pre">COMPONENT_DIRS</span></code> directories. Use this variable to “trim down” the project for faster build times. Note that any component which “requires” another component via the REQUIRES or PRIV_REQUIRES arguments on component registration will automatically have it added to this list, so the <code class="docutils literal notranslate"><span class="pre">COMPONENTS</span></code> list can be very short.</li>
</ul>
<p>Any paths in these variables can be absolute paths, or set relative to the project directory.</p>
<p>To set these variables, use the <a class="reference external" href="https://cmake.org/cmake/help/v3.5/command/set.html">cmake set command</a> ie <code class="docutils literal notranslate"><span class="pre">set(VARIABLE</span> <span class="pre">&quot;VALUE&quot;)</span></code>. The <code class="docutils literal notranslate"><span class="pre">set()</span></code> commands should be placed after the <code class="docutils literal notranslate"><span class="pre">cmake_minimum(...)</span></code> line but before the <code class="docutils literal notranslate"><span class="pre">include(...)</span></code> line.</p>
</div>
<div class="section" id="renaming-main-component">
<span id="rename-main"></span><h3>Renaming <code class="docutils literal notranslate"><span class="pre">main</span></code> component<a class="headerlink" href="#renaming-main-component" title="Permalink to this headline">¶</a></h3>
<p>The build system provides special treatment to the <code class="docutils literal notranslate"><span class="pre">main</span></code> component. It is a component that gets automatically added to the build provided
that it is in the expected location, PROJECT_DIR/main. All other components in the build are also added as its dependencies,
saving the user from hunting down dependencies and providing a build that works right out of the box. Renaming the <code class="docutils literal notranslate"><span class="pre">main</span></code> component
causes the loss of these behind-the-scences heavy lifting, requiring the user to specify the location of the newly renamed component
and manually specifying its dependencies. Specifically, the steps to renaming <code class="docutils literal notranslate"><span class="pre">main</span></code> are as follows:</p>
<ol class="arabic simple">
<li>Rename <code class="docutils literal notranslate"><span class="pre">main</span></code> directory.</li>
<li>Set <code class="docutils literal notranslate"><span class="pre">EXTRA_COMPONENT_DIRS</span></code> in the project CMakeLists.txt to include the renamed <code class="docutils literal notranslate"><span class="pre">main</span></code> directory.</li>
<li>Specify the dependencies in the renamed component’s CMakeLists.txt file via REQUIRES or PRIV_REQUIRES arguments <a class="reference internal" href="#cmake-minimal-component-cmakelists"><span class="std std-ref">on component registration</span></a>.</li>
</ol>
</div>
</div>
<div class="section" id="component-cmakelists-files">
<span id="component-directories"></span><h2>Component CMakeLists Files<a class="headerlink" href="#component-cmakelists-files" title="Permalink to this headline">¶</a></h2>
<p>Each project contains one or more components. Components can be part of ESP-IDF, part of the project’s own components directory, or added from custom component directories (<a class="reference internal" href="#component-directories"><span class="std std-ref">see above</span></a>).</p>
<p>A component is any directory in the <code class="docutils literal notranslate"><span class="pre">COMPONENT_DIRS</span></code> list which contains a <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> file.</p>
<div class="section" id="searching-for-components">
<h3>Searching for Components<a class="headerlink" href="#searching-for-components" title="Permalink to this headline">¶</a></h3>
<p>The list of directories in <code class="docutils literal notranslate"><span class="pre">COMPONENT_DIRS</span></code> is searched for the project’s components. Directories in this list can either be components themselves (ie they contain a <cite>CMakeLists.txt</cite> file), or they can be top-level directories whose sub-directories are components.</p>
<p>When CMake runs to configure the project, it logs the components included in the build. This list can be useful for debugging the inclusion/exclusion of certain components.</p>
</div>
<div class="section" id="multiple-components-with-the-same-name">
<h3>Multiple components with the same name<a class="headerlink" href="#multiple-components-with-the-same-name" title="Permalink to this headline">¶</a></h3>
<p>When ESP-IDF is collecting all the components to compile, it will do this in the order specified by <code class="docutils literal notranslate"><span class="pre">COMPONENT_DIRS</span></code>; by default, this means ESP-IDF’s internal components first, then the project’s components, and finally any components set in <code class="docutils literal notranslate"><span class="pre">EXTRA_COMPONENT_DIRS</span></code>. If two or more of these directories
contain component sub-directories with the same name, the component in the last place searched is used. This allows, for example, overriding ESP-IDF components
with a modified version by copying that component from the ESP-IDF components directory to the project components directory and then modifying it there.
If used in this way, the ESP-IDF directory itself can remain untouched.</p>
</div>
<div class="section" id="minimal-component-cmakelists">
<span id="cmake-minimal-component-cmakelists"></span><h3>Minimal Component CMakeLists<a class="headerlink" href="#minimal-component-cmakelists" title="Permalink to this headline">¶</a></h3>
<p>The minimal component <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> file simply registers the component to the build system using <code class="docutils literal notranslate"><span class="pre">idf_component_register</span></code>:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">idf_component_register</span><span class="p">(</span><span class="s">SRCS</span> <span class="s2">&quot;foo.c&quot;</span> <span class="s2">&quot;bar.c&quot;</span>
                       <span class="s">INCLUDE_DIRS</span> <span class="s2">&quot;include&quot;</span>
                       <span class="s">REQUIRES</span> <span class="s">mbedtls</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">SRCS</span></code> is a list of source files (<code class="docutils literal notranslate"><span class="pre">*.c</span></code>, <code class="docutils literal notranslate"><span class="pre">*.cpp</span></code>, <code class="docutils literal notranslate"><span class="pre">*.cc</span></code>, <code class="docutils literal notranslate"><span class="pre">*.S</span></code>). These source files will be compiled into the component library.</li>
<li><code class="docutils literal notranslate"><span class="pre">INCLUDE_DIRS</span></code> is a list of directories to add to the global include search path for any component which requires this component, and also the main source files.</li>
<li><code class="docutils literal notranslate"><span class="pre">REQUIRES</span></code> is not actually required, but it is very often required to declare what other components this component will use. See <a class="reference internal" href="#component-requirements"><span class="std std-ref">Component Requirements</span></a>.</li>
</ul>
<p>A library with the name of the component will be built and linked into the final app.
Directories are usually specified relative to the <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> file itself, although they can be absolute.</p>
<p>There are other arguments that can be passed to <code class="docutils literal notranslate"><span class="pre">idf_component_register</span></code>. These arguments
are discussed <a class="reference internal" href="#cmake-component-register"><span class="std std-ref">here</span></a>.</p>
<p>See <a class="reference internal" href="#example-component-requirements">example component requirements</a> and  <a class="reference internal" href="#example-component-cmakelists">example component CMakeLists</a> for more complete component <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> examples.</p>
</div>
<div class="section" id="preset-component-variables">
<span id="component-variables"></span><h3>Preset Component Variables<a class="headerlink" href="#preset-component-variables" title="Permalink to this headline">¶</a></h3>
<p>The following component-specific variables are available for use inside component CMakeLists, but should not be modified:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">COMPONENT_DIR</span></code>: The component directory. Evaluates to the absolute path of the directory containing <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code>. The component path cannot contain spaces. This is the same as the <code class="docutils literal notranslate"><span class="pre">CMAKE_CURRENT_SOURCE_DIR</span></code> variable.</li>
<li><code class="docutils literal notranslate"><span class="pre">COMPONENT_NAME</span></code>: Name of the component. Same as the name of the component directory.</li>
<li><code class="docutils literal notranslate"><span class="pre">COMPONENT_ALIAS</span></code>: Alias of the library created internally by the build system for the component.</li>
<li><code class="docutils literal notranslate"><span class="pre">COMPONENT_LIB</span></code>: Name of the library created internally by the build system for the component.</li>
</ul>
<p>The following variables are set at the project level, but available for use in component CMakeLists:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">CONFIG_*</span></code>: Each value in the project configuration has a corresponding variable available in cmake. All names begin with <code class="docutils literal notranslate"><span class="pre">CONFIG_</span></code>. <a class="reference internal" href="../api-reference/kconfig.html"><span class="doc">More information here</span></a>.</li>
<li><code class="docutils literal notranslate"><span class="pre">ESP_PLATFORM</span></code>: Set to 1 when the CMake file is processed within ESP-IDF build system.</li>
</ul>
</div>
<div class="section" id="build-project-variables">
<h3>Build/Project Variables<a class="headerlink" href="#build-project-variables" title="Permalink to this headline">¶</a></h3>
<p>The following are some project/build variables that are available as build properties and whose values can be queried using <code class="docutils literal notranslate"><span class="pre">idf_build_get_property</span></code>
from the component CMakeLists.txt:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">PROJECT_NAME</span></code>: Name of the project, as set in project CMakeLists.txt file.</li>
<li><code class="docutils literal notranslate"><span class="pre">PROJECT_DIR</span></code>: Absolute path of the project directory containing the project CMakeLists. Same as the <code class="docutils literal notranslate"><span class="pre">CMAKE_SOURCE_DIR</span></code> variable.</li>
<li><code class="docutils literal notranslate"><span class="pre">COMPONENTS</span></code>: Names of all components that are included in this build, formatted as a semicolon-delimited CMake list.</li>
<li><code class="docutils literal notranslate"><span class="pre">IDF_VER</span></code>: Git version of ESP-IDF (produced by <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">describe</span></code>)</li>
<li><code class="docutils literal notranslate"><span class="pre">IDF_VERSION_MAJOR</span></code>, <code class="docutils literal notranslate"><span class="pre">IDF_VERSION_MINOR</span></code>, <code class="docutils literal notranslate"><span class="pre">IDF_VERSION_PATCH</span></code>: Components of ESP-IDF version, to be used in conditional expressions. Note that this information is less precise than that provided by <code class="docutils literal notranslate"><span class="pre">IDF_VER</span></code> variable. <code class="docutils literal notranslate"><span class="pre">v4.0-dev-*</span></code>, <code class="docutils literal notranslate"><span class="pre">v4.0-beta1</span></code>, <code class="docutils literal notranslate"><span class="pre">v4.0-rc1</span></code> and <code class="docutils literal notranslate"><span class="pre">v4.0</span></code> will all have the same values of <code class="docutils literal notranslate"><span class="pre">IDF_VERSION_*</span></code> variables, but different <code class="docutils literal notranslate"><span class="pre">IDF_VER</span></code> values.</li>
<li><code class="docutils literal notranslate"><span class="pre">IDF_TARGET</span></code>: Name of the target for which the project is being built.</li>
<li><code class="docutils literal notranslate"><span class="pre">PROJECT_VER</span></code>: Project version.<ul>
<li>If <a class="reference internal" href="../api-reference/kconfig.html#config-app-project-ver-from-config"><span class="std std-ref">CONFIG_APP_PROJECT_VER_FROM_CONFIG</span></a> option is set, the value of <a class="reference internal" href="../api-reference/kconfig.html#config-app-project-ver"><span class="std std-ref">CONFIG_APP_PROJECT_VER</span></a> will be used.</li>
<li>Else, if <code class="docutils literal notranslate"><span class="pre">PROJECT_VER</span></code> variable is set in project CMakeLists.txt file, its value will be used.</li>
<li>Else, if the <code class="docutils literal notranslate"><span class="pre">PROJECT_DIR/version.txt</span></code> exists, its contents will be used as <code class="docutils literal notranslate"><span class="pre">PROJECT_VER</span></code>.</li>
<li>Else, if the project is located inside a Git repository, the output of git describe will be used.</li>
<li>Otherwise, <code class="docutils literal notranslate"><span class="pre">PROJECT_VER</span></code> will be “1”.</li>
</ul>
</li>
</ul>
<p>Other build properties are listed <a class="reference internal" href="#cmake-build-properties"><span class="std std-ref">here</span></a>.</p>
</div>
<div class="section" id="controlling-component-compilation">
<h3>Controlling Component Compilation<a class="headerlink" href="#controlling-component-compilation" title="Permalink to this headline">¶</a></h3>
<p>To pass compiler options when compiling source files belonging to a particular component, use the <code class="docutils literal notranslate"><span class="pre">target_compile_options</span></code> function:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">target_compile_options</span><span class="p">(</span><span class="o">${</span><span class="nv">COMPONENT_LIB</span><span class="o">}</span> <span class="s">PRIVATE</span> <span class="s">-Wno-unused-variable</span><span class="p">)</span>
</pre></div>
</div>
<p>To apply the compilation flags to a single source file, use the CMake <a class="reference external" href="https://cmake.org/cmake/help/v3.5/command/set_source_files_properties.html">set_source_files_properties</a> command:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">set_source_files_properties</span><span class="p">(</span><span class="s">mysrc.c</span>
    <span class="s">PROPERTIES</span> <span class="s">COMPILE_FLAGS</span>
    <span class="s">-Wno-unused-variable</span>
<span class="p">)</span>
</pre></div>
</div>
<p>This can be useful if there is upstream code that emits warnings.</p>
<p>When using these commands, place them after the call to <code class="docutils literal notranslate"><span class="pre">idf_component_register</span></code> in the component CMakeLists file.</p>
</div>
</div>
<div class="section" id="component-configuration">
<span id="id2"></span><h2>Component Configuration<a class="headerlink" href="#component-configuration" title="Permalink to this headline">¶</a></h2>
<p>Each component can also have a <code class="docutils literal notranslate"><span class="pre">Kconfig</span></code> file, alongside <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code>. This contains
configuration settings to add to the configuration menu for this component.</p>
<p>These settings are found under the “Component Settings” menu when menuconfig is run.</p>
<p>To create a component Kconfig file, it is easiest to start with one of the Kconfig files distributed with ESP-IDF.</p>
<p>For an example, see <a class="reference internal" href="#adding-conditional-configuration">Adding conditional configuration</a>.</p>
</div>
<div class="section" id="preprocessor-definitions">
<h2>Preprocessor Definitions<a class="headerlink" href="#preprocessor-definitions" title="Permalink to this headline">¶</a></h2>
<p>The ESP-IDF build system adds the following C preprocessor definitions on the command line:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">ESP_PLATFORM</span></code> : Can be used to detect that build happens within ESP-IDF.</li>
<li><code class="docutils literal notranslate"><span class="pre">IDF_VER</span></code> : Defined to a git version string.  E.g. <code class="docutils literal notranslate"><span class="pre">v2.0</span></code> for a tagged release or <code class="docutils literal notranslate"><span class="pre">v1.0-275-g0efaa4f</span></code> for an arbitrary commit.</li>
</ul>
</div>
<div class="section" id="component-requirements">
<span id="id3"></span><h2>Component Requirements<a class="headerlink" href="#component-requirements" title="Permalink to this headline">¶</a></h2>
<p>When compiling each component, the ESP-IDF build system recursively evaluates its dependencies. This means each component needs to declare the components that it depends on (“requires”).</p>
<div class="section" id="when-writing-a-component">
<h3>When writing a component<a class="headerlink" href="#when-writing-a-component" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">idf_component_register</span><span class="p">(</span><span class="s">...</span>
                       <span class="s">REQUIRES</span> <span class="s">mbedtls</span>
                       <span class="s">PRIV_REQUIRES</span> <span class="s">console</span> <span class="s">spiffs</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">REQUIRES</span></code> should be set to all components whose header files are #included from the <em>public</em> header files of this component.</li>
<li><code class="docutils literal notranslate"><span class="pre">PRIV_REQUIRES</span></code> should be set to all components whose header files are #included from <em>any source files</em> in this component, unless already listed in <code class="docutils literal notranslate"><span class="pre">REQUIRES</span></code>. Also any component which is required to be linked in order for this component to function correctly.</li>
<li>The values of <code class="docutils literal notranslate"><span class="pre">REQUIRES</span></code> and <code class="docutils literal notranslate"><span class="pre">PRIV_REQUIRES</span></code> should not depend on any configuration choices (<code class="docutils literal notranslate"><span class="pre">CONFIG_xxx</span></code> macros). This is because requirements are expanded before configuration is loaded. Other component variables (like include paths or source files) can depend on configuration choices.</li>
<li>Not setting either or both <code class="docutils literal notranslate"><span class="pre">REQUIRES</span></code> variables is fine. If the component has no requirements except for the <a class="reference internal" href="#common-component-requirements">Common component requirements</a> needed for RTOS, libc, etc.</li>
</ul>
<p>If a components only supports some target chips (values of <code class="docutils literal notranslate"><span class="pre">IDF_TARGET</span></code>) then it can specify <code class="docutils literal notranslate"><span class="pre">REQUIRED_IDF_TARGETS</span></code> in the <code class="docutils literal notranslate"><span class="pre">idf_component_register</span></code> call to express these requirements. In this case the build system will generate an error if the component is included into the build, but does not support the selected target.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In CMake terms, <code class="docutils literal notranslate"><span class="pre">REQUIRES</span></code> &amp; <code class="docutils literal notranslate"><span class="pre">PRIV_REQUIRES</span></code> are approximate wrappers around the CMake functions <code class="docutils literal notranslate"><span class="pre">target_link_libraries(...</span> <span class="pre">PUBLIC</span> <span class="pre">...)</span></code> and <code class="docutils literal notranslate"><span class="pre">target_link_libraries(...</span> <span class="pre">PRIVATE</span> <span class="pre">...)</span></code>.</p>
</div>
</div>
<div class="section" id="example-of-component-requirements">
<span id="example-component-requirements"></span><h3>Example of component requirements<a class="headerlink" href="#example-of-component-requirements" title="Permalink to this headline">¶</a></h3>
<p>Imagine there is a <code class="docutils literal notranslate"><span class="pre">car</span></code> component, which uses the <code class="docutils literal notranslate"><span class="pre">engine</span></code> component, which uses the <code class="docutils literal notranslate"><span class="pre">spark_plug</span></code> component:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>- autoProject/
             - CMakeLists.txt
             - components/ - car/ - CMakeLists.txt
                                     - car.c
                                     - car.h
                           - engine/ - CMakeLists.txt
                                     - engine.c
                                     - include/ - engine.h
                           - spark_plug/  - CMakeLists.txt
                                          - plug.c
                                          - plug.h
</pre></div>
</div>
<div class="section" id="car-component">
<h4>Car component<a class="headerlink" href="#car-component" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">car.h</span></code> header file is the public interface for the <code class="docutils literal notranslate"><span class="pre">car</span></code> component. This header includes <code class="docutils literal notranslate"><span class="pre">engine.h</span></code> directly because it uses some declarations from this header:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* car.h */</span>
<span class="cp">#include</span> <span class="cpf">&quot;engine.h&quot;</span><span class="cp"></span>

<span class="cp">#ifdef ENGINE_IS_HYBRID</span>
<span class="cp">#define CAR_MODEL &quot;Hybrid&quot;</span>
<span class="cp">#endif</span>
</pre></div>
</div>
<p>And car.c includes <code class="docutils literal notranslate"><span class="pre">car.h</span></code> as well:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* car.c */</span>
<span class="cp">#include</span> <span class="cpf">&quot;car.h&quot;</span><span class="cp"></span>
</pre></div>
</div>
<p>This means the <code class="docutils literal notranslate"><span class="pre">car/CMakeLists.txt</span></code> file needs to declare that <code class="docutils literal notranslate"><span class="pre">car</span></code> requires <code class="docutils literal notranslate"><span class="pre">engine</span></code>:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">idf_component_register</span><span class="p">(</span><span class="s">SRCS</span> <span class="s2">&quot;car.c&quot;</span>
                  <span class="s">INCLUDE_DIRS</span> <span class="s2">&quot;.&quot;</span>
                  <span class="s">REQUIRES</span> <span class="s">engine</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">SRCS</span></code> gives the list of source files in the <code class="docutils literal notranslate"><span class="pre">car</span></code> component.</li>
<li><code class="docutils literal notranslate"><span class="pre">INCLUDE_DIRS</span></code> gives the list of public include directories for this component. Because the public interface is <code class="docutils literal notranslate"><span class="pre">car.h</span></code>, the directory containing <code class="docutils literal notranslate"><span class="pre">car.h</span></code> is listed here.</li>
<li><code class="docutils literal notranslate"><span class="pre">REQUIRES</span></code> gives the list of components required by the public interface of this component. Because <code class="docutils literal notranslate"><span class="pre">car.h</span></code> is a public header and includes a header from <code class="docutils literal notranslate"><span class="pre">engine</span></code>, we include <code class="docutils literal notranslate"><span class="pre">engine</span></code> here. This makes sure that any other component which includes <code class="docutils literal notranslate"><span class="pre">car.h</span></code> will be able to recursively include the required <code class="docutils literal notranslate"><span class="pre">engine.h</span></code> also.</li>
</ul>
</div>
<div class="section" id="engine-component">
<h4>Engine component<a class="headerlink" href="#engine-component" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">engine</span></code> component also has a public header file <code class="docutils literal notranslate"><span class="pre">include/engine.h</span></code>, but this header is simpler:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* engine.h */</span>
<span class="cp">#define ENGINE_IS_HYBRID</span>

<span class="kt">void</span> <span class="nf">engine_start</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</pre></div>
</div>
<p>The implementation is in <code class="docutils literal notranslate"><span class="pre">engine.c</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* engine.c */</span>
<span class="cp">#include</span> <span class="cpf">&quot;engine.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;spark_plug.h&quot;</span><span class="cp"></span>

<span class="p">...</span>
</pre></div>
</div>
<p>In this component, <code class="docutils literal notranslate"><span class="pre">engine</span></code> depends on <code class="docutils literal notranslate"><span class="pre">spark_plug</span></code> but this is a private dependency. <code class="docutils literal notranslate"><span class="pre">spark_plug.h</span></code> is needed to compile <code class="docutils literal notranslate"><span class="pre">engine.c</span></code>, but not needed to include <code class="docutils literal notranslate"><span class="pre">engine.h</span></code>.</p>
<p>This means that the <code class="docutils literal notranslate"><span class="pre">engine/CMakeLists.txt</span></code> file can use <code class="docutils literal notranslate"><span class="pre">PRIV_REQUIRES</span></code>:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">idf_component_register</span><span class="p">(</span><span class="s">SRCS</span> <span class="s2">&quot;engine.c&quot;</span>
                  <span class="s">INCLUDE_DIRS</span> <span class="s2">&quot;include&quot;</span>
                  <span class="s">PRIV_REQUIRES</span> <span class="s">spark_plug</span><span class="p">)</span>
</pre></div>
</div>
<p>As a result, source files in the <code class="docutils literal notranslate"><span class="pre">car</span></code> component don’t need the <code class="docutils literal notranslate"><span class="pre">spark_plug</span></code> include directories added to their compiler search path. This can speed up compilation, and stops compiler command lines from becoming longer than necessary.</p>
</div>
<div class="section" id="spark-plug-component">
<h4>Spark Plug Component<a class="headerlink" href="#spark-plug-component" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">spark_plug</span></code> component doesn’t depend on anything else. It has a public header file <code class="docutils literal notranslate"><span class="pre">spark_plug.h</span></code>, but this doesn’t include headers from any other components.</p>
<p>This means that the <code class="docutils literal notranslate"><span class="pre">spark_plug/CMakeLists.txt</span></code> file doesn’t need any <code class="docutils literal notranslate"><span class="pre">REQUIRES</span></code> or <code class="docutils literal notranslate"><span class="pre">PRIV_REQUIRES</span></code> clauses:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">idf_component_register</span><span class="p">(</span><span class="s">SRCS</span> <span class="s2">&quot;spark_plug.c&quot;</span>
                  <span class="s">INCLUDE_DIRS</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="source-file-include-directories">
<h3>Source File Include Directories<a class="headerlink" href="#source-file-include-directories" title="Permalink to this headline">¶</a></h3>
<p>Each component’s source file is compiled with these include path directories, as specified in the passed arguments to <code class="docutils literal notranslate"><span class="pre">idf_component_register</span></code>:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">idf_component_register</span><span class="p">(</span><span class="s">..</span>
                       <span class="s">INCLUDE_DIRS</span> <span class="s2">&quot;include&quot;</span>
                       <span class="s">PRIV_INCLUDE_DIRS</span> <span class="s2">&quot;other&quot;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li>The current component’s <code class="docutils literal notranslate"><span class="pre">INCLUDE_DIRS</span></code> and <code class="docutils literal notranslate"><span class="pre">PRIV_INCLUDE_DIRS</span></code>.</li>
<li>The <code class="docutils literal notranslate"><span class="pre">INCLUDE_DIRS</span></code> belonging to all other components listed in the <code class="docutils literal notranslate"><span class="pre">REQUIRES</span></code> and <code class="docutils literal notranslate"><span class="pre">PRIV_REQUIRES</span></code> parameters (ie all the current component’s public and private dependencies).</li>
<li>Recursively, all of the <code class="docutils literal notranslate"><span class="pre">INCLUDE_DIRS</span></code> of those components <code class="docutils literal notranslate"><span class="pre">REQUIRES</span></code> lists (ie all public dependencies of this component’s dependencies, recursively expanded).</li>
</ul>
</div>
<div class="section" id="main-component-requirements">
<h3>Main component requirements<a class="headerlink" href="#main-component-requirements" title="Permalink to this headline">¶</a></h3>
<p>The component named <code class="docutils literal notranslate"><span class="pre">main</span></code> is special because it automatically requires all other components in the build. So it’s not necessary to pass <code class="docutils literal notranslate"><span class="pre">REQUIRES</span></code> or <code class="docutils literal notranslate"><span class="pre">PRIV_REQUIRES</span></code> to this component. See <a class="reference internal" href="#rename-main"><span class="std std-ref">renaming main</span></a> for a description of what needs to be changed if no longer using the <code class="docutils literal notranslate"><span class="pre">main</span></code> component.</p>
</div>
<div class="section" id="common-component-requirements">
<h3>Common component requirements<a class="headerlink" href="#common-component-requirements" title="Permalink to this headline">¶</a></h3>
<p>To avoid duplication, every component automatically requires some “common” IDF components even if they are not mentioned explicitly. Headers from these components can always be included.</p>
<p>The list of common components is: freertos, newlib, heap, log, soc, esp_rom, esp_common, xtensa, cxx.</p>
</div>
<div class="section" id="including-components-in-the-build">
<h3>Including components in the build<a class="headerlink" href="#including-components-in-the-build" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>By default, every component is included in the build.</li>
<li>If you set the <code class="docutils literal notranslate"><span class="pre">COMPONENTS</span></code> variable to a minimal list of components used directly by your project, then the build will expand to also include required components. The full list of components will be:<ul>
<li>Components mentioned explicitly in <code class="docutils literal notranslate"><span class="pre">COMPONENTS</span></code>.</li>
<li>Those components’ requirements (evaluated recursively).</li>
<li>The “common” components that every component depends on.</li>
</ul>
</li>
<li>Setting <code class="docutils literal notranslate"><span class="pre">COMPONENTS</span></code> to the minimal list of required components can significantly reduce compile times.</li>
</ul>
</div>
<div class="section" id="requirements-in-the-build-system-implementation">
<span id="component-requirements-implementation"></span><h3>Requirements in the build system implementation<a class="headerlink" href="#requirements-in-the-build-system-implementation" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Very early in the CMake configuration process, the script <code class="docutils literal notranslate"><span class="pre">expand_requirements.cmake</span></code> is run. This script does a partial evaluation of all component CMakeLists.txt files and builds a graph of component requirements (this graph may have cycles). The graph is used to generate a file <code class="docutils literal notranslate"><span class="pre">component_depends.cmake</span></code> in the build directory.</li>
<li>The main CMake process then includes this file and uses it to determine the list of components to include in the build (internal <code class="docutils literal notranslate"><span class="pre">BUILD_COMPONENTS</span></code> variable). The <code class="docutils literal notranslate"><span class="pre">BUILD_COMPONENTS</span></code> variable is sorted so dependencies are listed first, however as the component dependency graph has cycles this cannot be guaranteed for all components. The order should be deterministic given the same set of components and component dependencies.</li>
<li>The value of <code class="docutils literal notranslate"><span class="pre">BUILD_COMPONENTS</span></code> is logged by CMake as “Component names: “</li>
<li>Configuration is then evaluated for the components included in the build.</li>
<li>Each component is included in the build normally and the CMakeLists.txt file is evaluated again to add the component libraries to the build.</li>
</ul>
<div class="section" id="component-dependency-order">
<h4>Component Dependency Order<a class="headerlink" href="#component-dependency-order" title="Permalink to this headline">¶</a></h4>
<p>The order of components in the <code class="docutils literal notranslate"><span class="pre">BUILD_COMPONENTS</span></code> variable determines other orderings during the build:</p>
<ul class="simple">
<li>Order that <a class="reference internal" href="#project-include-cmake"><span class="std std-ref">project_include.cmake</span></a> files are included into the project.</li>
<li>Order that the list of header paths is generated for compilation (via <code class="docutils literal notranslate"><span class="pre">-I</span></code> argument). (Note that for a given component’s source files, only that component’s dependency’s header paths are passed to the compiler.)</li>
</ul>
</div>
</div>
</div>
<div class="section" id="overriding-parts-of-the-project">
<h2>Overriding Parts of the Project<a class="headerlink" href="#overriding-parts-of-the-project" title="Permalink to this headline">¶</a></h2>
<div class="section" id="project-include-cmake">
<span id="id4"></span><h3>project_include.cmake<a class="headerlink" href="#project-include-cmake" title="Permalink to this headline">¶</a></h3>
<p>For components that have build requirements which must be evaluated before any component CMakeLists
files are evaluated, you can create a file called <code class="docutils literal notranslate"><span class="pre">project_include.cmake</span></code> in the
component directory. This CMake file is included when <code class="docutils literal notranslate"><span class="pre">project.cmake</span></code> is evaluating the entire project.</p>
<p><code class="docutils literal notranslate"><span class="pre">project_include.cmake</span></code> files are used inside ESP-IDF, for defining project-wide build features such as <code class="docutils literal notranslate"><span class="pre">esptool.py</span></code> command line arguments and the <code class="docutils literal notranslate"><span class="pre">bootloader</span></code> “special app”.</p>
<p>Unlike component <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> files, when including a <code class="docutils literal notranslate"><span class="pre">project_include.cmake</span></code> file the current source directory (<code class="docutils literal notranslate"><span class="pre">CMAKE_CURRENT_SOURCE_DIR</span></code> and working directory) is the project directory. Use the variable <code class="docutils literal notranslate"><span class="pre">COMPONENT_DIR</span></code> for the absolute directory of the component.</p>
<p>Note that <code class="docutils literal notranslate"><span class="pre">project_include.cmake</span></code> isn’t necessary for the most common component uses - such as adding include directories to the project, or <code class="docutils literal notranslate"><span class="pre">LDFLAGS</span></code> to the final linking step. These values can be customised via the <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> file itself. See <a class="reference internal" href="#optional-project-variables">Optional Project Variables</a> for details.</p>
<p><code class="docutils literal notranslate"><span class="pre">project_include.cmake</span></code> files are included in the order given in <code class="docutils literal notranslate"><span class="pre">BUILD_COMPONENTS</span></code> variable (as logged by CMake). This means that a component’s <code class="docutils literal notranslate"><span class="pre">project_include.cmake</span></code> file will be included after it’s all dependencies’ <code class="docutils literal notranslate"><span class="pre">project_include.cmake</span></code> files, unless both components are part of a dependency cycle. This is important if a <code class="docutils literal notranslate"><span class="pre">project_include.cmake</span></code> file relies on variables set by another component. See also <a class="reference internal" href="#component-requirements-implementation"><span class="std std-ref">above</span></a>.</p>
<p>Take great care when setting variables or targets in a <code class="docutils literal notranslate"><span class="pre">project_include.cmake</span></code> file. As the values are included into the top-level project CMake pass, they can influence or break functionality across all components!</p>
</div>
<div class="section" id="kconfig-projbuild">
<h3>KConfig.projbuild<a class="headerlink" href="#kconfig-projbuild" title="Permalink to this headline">¶</a></h3>
<p>This is an equivalent to <code class="docutils literal notranslate"><span class="pre">project_include.cmake</span></code> for <a class="reference internal" href="#component-configuration"><span class="std std-ref">Component Configuration</span></a> KConfig files. If you want to include
configuration options at the top-level of menuconfig, rather than inside the “Component Configuration” sub-menu, then these can be defined in the KConfig.projbuild file alongside the <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> file.</p>
<p>Take care when adding configuration values in this file, as they will be included across the entire project configuration. Where possible, it’s generally better to create a KConfig file for <a class="reference internal" href="#component-configuration"><span class="std std-ref">Component Configuration</span></a>.</p>
<p><code class="docutils literal notranslate"><span class="pre">project_include.cmake</span></code> files are used inside ESP-IDF, for defining project-wide build features such as <code class="docutils literal notranslate"><span class="pre">esptool.py</span></code> command line arguments and the <code class="docutils literal notranslate"><span class="pre">bootloader</span></code> “special app”.</p>
</div>
</div>
<div class="section" id="configuration-only-components">
<h2>Configuration-Only Components<a class="headerlink" href="#configuration-only-components" title="Permalink to this headline">¶</a></h2>
<p>Special components which contain no source files, only <code class="docutils literal notranslate"><span class="pre">Kconfig.projbuild</span></code> and <code class="docutils literal notranslate"><span class="pre">KConfig</span></code>, can have a one-line <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> file which calls the function <code class="docutils literal notranslate"><span class="pre">idf_component_register()</span></code> with no
arguments specified. This function will include the component in the project build, but no library will be built <em>and</em> no header files will be added to any include paths.</p>
</div>
<div class="section" id="debugging-cmake">
<h2>Debugging CMake<a class="headerlink" href="#debugging-cmake" title="Permalink to this headline">¶</a></h2>
<p>For full details about <a class="reference external" href="https://cmake.org/">CMake</a> and CMake commands, see the <a class="reference external" href="https://cmake.org/cmake/help/v3.5/index.html">CMake v3.5 documentation</a>.</p>
<p>Some tips for debugging the ESP-IDF CMake-based build system:</p>
<ul class="simple">
<li>When CMake runs, it prints quite a lot of diagnostic information including lists of components and component paths.</li>
<li>Running <code class="docutils literal notranslate"><span class="pre">cmake</span> <span class="pre">-DDEBUG=1</span></code> will produce more verbose diagnostic output from the IDF build system.</li>
<li>Running <code class="docutils literal notranslate"><span class="pre">cmake</span></code> with the <code class="docutils literal notranslate"><span class="pre">--trace</span></code> or <code class="docutils literal notranslate"><span class="pre">--trace-expand</span></code> options will give a lot of information about control flow. See the <a class="reference external" href="https://cmake.org/cmake/help/v3.5/manual/cmake.1.html#options">cmake command line documentation</a>.</li>
</ul>
<p>When included from a project CMakeLists file, the <code class="docutils literal notranslate"><span class="pre">project.cmake</span></code> file defines some utility modules and global variables and then sets <code class="docutils literal notranslate"><span class="pre">IDF_PATH</span></code> if it was not set in the system environment.</p>
<p>It also defines an overridden custom version of the built-in <a class="reference external" href="https://cmake.org/">CMake</a> <code class="docutils literal notranslate"><span class="pre">project</span></code> function. This function is overridden to add all of the ESP-IDF specific project functionality.</p>
<div class="section" id="warning-on-undefined-variables">
<span id="warn-undefined-variables"></span><h3>Warning On Undefined Variables<a class="headerlink" href="#warning-on-undefined-variables" title="Permalink to this headline">¶</a></h3>
<p>By default, <code class="docutils literal notranslate"><span class="pre">idf.py</span></code> passes the <code class="docutils literal notranslate"><span class="pre">--warn-uninitialized</span></code> flag to <a class="reference external" href="https://cmake.org/">CMake</a> so it will print a warning if an undefined variable is referenced in the build. This can be very useful to find buggy CMake files.</p>
<p>If you don’t want this behaviour, it can be disabled by passing <code class="docutils literal notranslate"><span class="pre">--no-warnings</span></code> to <code class="docutils literal notranslate"><span class="pre">idf.py</span></code>.</p>
<p>Browse the <a class="reference external" href="https://github.com/espressif/esp-idf/blob/f91080637//tools/cmake/project.cmake">/tools/cmake/project.cmake</a> file and supporting functions in <a class="reference external" href="https://github.com/espressif/esp-idf/blob/f91080637//tools/cmake/idf_functions.cmake">/tools/cmake/idf_functions.cmake</a> for more details.</p>
</div>
</div>
<div class="section" id="example-component-cmakelists">
<span id="gnu-make-to-cmake"></span><h2>Example Component CMakeLists<a class="headerlink" href="#example-component-cmakelists" title="Permalink to this headline">¶</a></h2>
<p>Because the build environment tries to set reasonable defaults that will work most
of the time, component <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> can be very small or even empty (see <a class="reference internal" href="#minimal-component-cmakelists">Minimal Component CMakeLists</a>). However, overriding <a class="reference internal" href="#component-variables">component variables</a> is usually required for some functionality.</p>
<p>Here are some more advanced examples of component CMakeLists files.</p>
<div class="section" id="adding-conditional-configuration">
<h3>Adding conditional configuration<a class="headerlink" href="#adding-conditional-configuration" title="Permalink to this headline">¶</a></h3>
<p>The configuration system can be used to conditionally compile some files
depending on the options selected in the project configuration.</p>
<p><code class="docutils literal notranslate"><span class="pre">Kconfig</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>config FOO_ENABLE_BAR
    bool &quot;Enable the BAR feature.&quot;
    help
        This enables the BAR feature of the FOO component.
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span> set(srcs &quot;foo.c&quot; &quot;more_foo.c&quot;)

 if(CONFIG_FOO_ENABLE_BAR)
     list(APPEND srcs &quot;bar.c&quot;)
 endif()

idf_component_register(SRCS &quot;${srcs}&quot;
                     ...)
</pre></div>
</div>
<p>This example makes use of the CMake <a class="reference external" href="https://cmake.org/cmake/help/v3.5/command/if.html">if</a> function and <a class="reference external" href="https://cmake.org/cmake/help/v3.5/command/list.html">list APPEND</a> function.</p>
<p>This can also be used to select or stub out an implementation, as such:</p>
<p><code class="docutils literal notranslate"><span class="pre">Kconfig</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>config ENABLE_LCD_OUTPUT
    bool &quot;Enable LCD output.&quot;
    help
        Select this if your board has a LCD.

config ENABLE_LCD_CONSOLE
    bool &quot;Output console text to LCD&quot;
    depends on ENABLE_LCD_OUTPUT
    help
        Select this to output debugging output to the lcd

config ENABLE_LCD_PLOT
    bool &quot;Output temperature plots to LCD&quot;
    depends on ENABLE_LCD_OUTPUT
    help
        Select this to output temperature plots
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code>:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">if</span><span class="p">(</span><span class="s">CONFIG_ENABLE_LCD_OUTPUT</span><span class="p">)</span>
   <span class="nb">set</span><span class="p">(</span><span class="s">srcs</span> <span class="s">lcd-real.c</span> <span class="s">lcd-spi.c</span><span class="p">)</span>
<span class="nb">else</span><span class="p">()</span>
   <span class="nb">set</span><span class="p">(</span><span class="s">srcs</span> <span class="s">lcd-dummy.c</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>

<span class="c"># We need font if either console or plot is enabled</span>
<span class="nb">if</span><span class="p">(</span><span class="s">CONFIG_ENABLE_LCD_CONSOLE</span> <span class="s">OR</span> <span class="s">CONFIG_ENABLE_LCD_PLOT</span><span class="p">)</span>
   <span class="nb">list</span><span class="p">(</span><span class="s">APPEND</span> <span class="s">srcs</span> <span class="s2">&quot;font.c&quot;</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>

<span class="nb">idf_component_register</span><span class="p">(</span><span class="s">SRCS</span> <span class="s2">&quot;${srcs}&quot;</span>
                    <span class="s">...</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="conditions-which-depend-on-the-target">
<h3>Conditions which depend on the target<a class="headerlink" href="#conditions-which-depend-on-the-target" title="Permalink to this headline">¶</a></h3>
<p>The current target is available to CMake files via <code class="docutils literal notranslate"><span class="pre">IDF_TARGET</span></code> variable.</p>
<p>In addition to that, if target <code class="docutils literal notranslate"><span class="pre">xyz</span></code> is used (<code class="docutils literal notranslate"><span class="pre">IDF_TARGET=xyz</span></code>), then Kconfig variable <code class="docutils literal notranslate"><span class="pre">CONFIG_IDF_TARGET_XYZ</span></code> will be set.</p>
<p>Note that component dependencies may depend on <code class="docutils literal notranslate"><span class="pre">IDF_TARGET</span></code> variable, but not on Kconfig variables. Also one can not use Kconfig variables in <code class="docutils literal notranslate"><span class="pre">include</span></code> statements in CMake files, but <code class="docutils literal notranslate"><span class="pre">IDF_TARGET</span></code> can be used in such context.</p>
</div>
<div class="section" id="source-code-generation">
<h3>Source Code Generation<a class="headerlink" href="#source-code-generation" title="Permalink to this headline">¶</a></h3>
<p>Some components will have a situation where a source file isn’t
supplied with the component itself but has to be generated from
another file. Say our component has a header file that consists of the
converted binary data of a BMP file, converted using a hypothetical
tool called bmp2h. The header file is then included in as C source
file called graphics_lib.c:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">add_custom_command</span><span class="p">(</span><span class="s">OUTPUT</span> <span class="s">logo.h</span>
     <span class="s">COMMAND</span> <span class="s">bmp2h</span> <span class="s">-i</span> <span class="o">${</span><span class="nv">COMPONENT_DIR</span><span class="o">}</span><span class="s">/logo.bmp</span> <span class="s">-o</span> <span class="s">log.h</span>
     <span class="s">DEPENDS</span> <span class="o">${</span><span class="nv">COMPONENT_DIR</span><span class="o">}</span><span class="s">/logo.bmp</span>
     <span class="s">VERBATIM</span><span class="p">)</span>

<span class="nb">add_custom_target</span><span class="p">(</span><span class="s">logo</span> <span class="s">DEPENDS</span> <span class="s">logo.h</span><span class="p">)</span>
<span class="nb">add_dependencies</span><span class="p">(</span><span class="o">${</span><span class="nv">COMPONENT_LIB</span><span class="o">}</span> <span class="s">logo</span><span class="p">)</span>

<span class="nb">set_property</span><span class="p">(</span><span class="s">DIRECTORY</span> <span class="s2">&quot;${COMPONENT_DIR}&quot;</span> <span class="s">APPEND</span> <span class="s">PROPERTY</span>
     <span class="s">ADDITIONAL_MAKE_CLEAN_FILES</span> <span class="s">logo.h</span><span class="p">)</span>
</pre></div>
</div>
<p>This answer is adapted from the <a class="reference external" href="https://cmake.org/Wiki/CMake_FAQ#How_can_I_generate_a_source_file_during_the_build.3F">CMake FAQ entry</a>, which contains some other examples that will also work with ESP-IDF builds.</p>
<p>In this example, logo.h will be generated in the
current directory (the build directory) while logo.bmp comes with the
component and resides under the component path. Because logo.h is a
generated file, it should be cleaned when the project is cleaned. For this reason
it is added to the <a class="reference external" href="https://cmake.org/cmake/help/v3.5/prop_dir/ADDITIONAL_MAKE_CLEAN_FILES.html">ADDITIONAL_MAKE_CLEAN_FILES</a> property.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If generating files as part of the project CMakeLists.txt file, not a component CMakeLists.txt, then use build property <code class="docutils literal notranslate"><span class="pre">PROJECT_DIR</span></code> instead of <code class="docutils literal notranslate"><span class="pre">${COMPONENT_DIR}</span></code> and <code class="docutils literal notranslate"><span class="pre">${PROJECT_NAME}.elf</span></code> instead of <code class="docutils literal notranslate"><span class="pre">${COMPONENT_LIB}</span></code>.)</p>
</div>
<p>If a a source file from another component included <code class="docutils literal notranslate"><span class="pre">logo.h</span></code>, then <code class="docutils literal notranslate"><span class="pre">add_dependencies</span></code> would need to be called to add a dependency between
the two components, to ensure that the component source files were always compiled in the correct order.</p>
</div>
<div class="section" id="embedding-binary-data">
<span id="cmake-embed-data"></span><h3>Embedding Binary Data<a class="headerlink" href="#embedding-binary-data" title="Permalink to this headline">¶</a></h3>
<p>Sometimes you have a file with some binary or text data that you’d like to make available to your component - but you don’t want to reformat the file as C source.</p>
<p>You can specify argument <code class="docutils literal notranslate"><span class="pre">EMBED_FILES</span></code> in the component registration, giving space-delimited names of the files to embed:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">idf_component_register</span><span class="p">(</span><span class="s">...</span>
                       <span class="s">EMBED_FILES</span> <span class="s">server_root_cert.der</span><span class="p">)</span>
</pre></div>
</div>
<p>Or if the file is a string, you can use the variable <code class="docutils literal notranslate"><span class="pre">EMBED_TXTFILES</span></code>. This will embed the contents of the text file as a null-terminated string:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">idf_component_register</span><span class="p">(</span><span class="s">...</span>
                       <span class="s">EMBED_TXTFILES</span> <span class="s">server_root_cert.pem</span><span class="p">)</span>
</pre></div>
</div>
<p>The file’s contents will be added to the .rodata section in flash, and are available via symbol names as follows:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">extern</span> <span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">server_root_cert_pem_start</span><span class="p">[]</span> <span class="k">asm</span><span class="p">(</span><span class="s">&quot;_binary_server_root_cert_pem_start&quot;</span><span class="p">);</span>
<span class="k">extern</span> <span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">server_root_cert_pem_end</span><span class="p">[]</span>   <span class="k">asm</span><span class="p">(</span><span class="s">&quot;_binary_server_root_cert_pem_end&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>The names are generated from the full name of the file, as given in <code class="docutils literal notranslate"><span class="pre">EMBED_FILES</span></code>. Characters /, ., etc. are replaced with underscores. The _binary prefix in the symbol name is added by objcopy and is the same for both text and binary files.</p>
<p>To embed a file into a project, rather than a component, you can call the function <code class="docutils literal notranslate"><span class="pre">target_add_binary_data</span></code> like this:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">target_add_binary_data</span><span class="p">(</span><span class="s">myproject.elf</span> <span class="s2">&quot;main/data.bin&quot;</span> <span class="s">TEXT</span><span class="p">)</span>
</pre></div>
</div>
<p>Place this line after the <code class="docutils literal notranslate"><span class="pre">project()</span></code> line in your project CMakeLists.txt file. Replace <code class="docutils literal notranslate"><span class="pre">myproject.elf</span></code> with your project name. The final argument can be <code class="docutils literal notranslate"><span class="pre">TEXT</span></code> to embed a null-terminated string, or <code class="docutils literal notranslate"><span class="pre">BINARY</span></code> to embed the content as-is.</p>
<p>For an example of using this technique, see <a class="reference external" href="https://github.com/espressif/esp-idf/tree/f91080637/examples/protocols/https_request">protocols/https_request</a> - the certificate file contents are loaded from the text .pem file at compile time.</p>
</div>
<div class="section" id="code-and-data-placements">
<h3>Code and Data Placements<a class="headerlink" href="#code-and-data-placements" title="Permalink to this headline">¶</a></h3>
<p>ESP-IDF has a feature called linker script generation that enables components to define where its code and data will be placed in memory through
linker fragment files. These files are processed by the build system, and is used to augment the linker script used for linking
app binary. See <a class="reference internal" href="linker-script-generation.html"><span class="doc">Linker Script Generation</span></a> for a quick start guide as well as a detailed discussion
of the mechanism.</p>
</div>
<div class="section" id="fully-overriding-the-component-build-process">
<span id="component-build-full-override"></span><h3>Fully Overriding The Component Build Process<a class="headerlink" href="#fully-overriding-the-component-build-process" title="Permalink to this headline">¶</a></h3>
<p>Obviously, there are cases where all these recipes are insufficient for a
certain component, for example when the component is basically a wrapper
around another third-party component not originally intended to be
compiled under this build system. In that case, it’s possible to forego
the ESP-IDF build system entirely by using a CMake feature called <a class="reference external" href="https://cmake.org/cmake/help/v3.5/module/ExternalProject.html">ExternalProject</a>. Example component CMakeLists:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># External build process for quirc, runs in source dir and</span>
<span class="c"># produces libquirc.a</span>
<span class="nb">externalproject_add</span><span class="p">(</span><span class="s">quirc_build</span>
    <span class="s">PREFIX</span> <span class="o">${</span><span class="nv">COMPONENT_DIR</span><span class="o">}</span>
    <span class="s">SOURCE_DIR</span> <span class="o">${</span><span class="nv">COMPONENT_DIR</span><span class="o">}</span><span class="s">/quirc</span>
    <span class="s">CONFIGURE_COMMAND</span> <span class="s2">&quot;&quot;</span>
    <span class="s">BUILD_IN_SOURCE</span> <span class="s">1</span>
    <span class="s">BUILD_COMMAND</span> <span class="s">make</span> <span class="s">CC=</span><span class="o">${</span><span class="nv">CMAKE_C_COMPILER</span><span class="o">}</span> <span class="s">libquirc.a</span>
    <span class="s">INSTALL_COMMAND</span> <span class="s2">&quot;&quot;</span>
    <span class="p">)</span>

 <span class="c"># Add libquirc.a to the build process</span>
 <span class="c">#</span>
 <span class="nb">add_library</span><span class="p">(</span><span class="s">quirc</span> <span class="s">STATIC</span> <span class="s">IMPORTED</span> <span class="s">GLOBAL</span><span class="p">)</span>
 <span class="nb">add_dependencies</span><span class="p">(</span><span class="s">quirc</span> <span class="s">quirc_build</span><span class="p">)</span>

 <span class="nb">set_target_properties</span><span class="p">(</span><span class="s">quirc</span> <span class="s">PROPERTIES</span> <span class="s">IMPORTED_LOCATION</span>
      <span class="o">${</span><span class="nv">COMPONENT_DIR</span><span class="o">}</span><span class="s">/quirc/libquirc.a</span><span class="p">)</span>
 <span class="nb">set_target_properties</span><span class="p">(</span><span class="s">quirc</span> <span class="s">PROPERTIES</span> <span class="s">INTERFACE_INCLUDE_DIRECTORIES</span>
      <span class="o">${</span><span class="nv">COMPONENT_DIR</span><span class="o">}</span><span class="s">/quirc/lib</span><span class="p">)</span>

 <span class="nb">set_directory_properties</span><span class="p">(</span> <span class="s">PROPERTIES</span> <span class="s">ADDITIONAL_MAKE_CLEAN_FILES</span>
      <span class="s2">&quot;${COMPONENT_DIR}/quirc/libquirc.a&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>(The above CMakeLists.txt can be used to create a component named <code class="docutils literal notranslate"><span class="pre">quirc</span></code> that builds the <a class="reference external" href="https://github.com/dlbeer/quirc">quirc</a> project using its own Makefile.)</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">externalproject_add</span></code> defines an external build system.<ul>
<li><code class="docutils literal notranslate"><span class="pre">SOURCE_DIR</span></code>, <code class="docutils literal notranslate"><span class="pre">CONFIGURE_COMMAND</span></code>, <code class="docutils literal notranslate"><span class="pre">BUILD_COMMAND</span></code> and <code class="docutils literal notranslate"><span class="pre">INSTALL_COMMAND</span></code> should always be set. <code class="docutils literal notranslate"><span class="pre">CONFIGURE_COMMAND</span></code> can be set to an empty string if the build system has no “configure” step. <code class="docutils literal notranslate"><span class="pre">INSTALL_COMMAND</span></code> will generally be empty for ESP-IDF builds.</li>
<li>Setting <code class="docutils literal notranslate"><span class="pre">BUILD_IN_SOURCE</span></code> means the build directory is the same as the source directory. Otherwise you can set <code class="docutils literal notranslate"><span class="pre">BUILD_DIR</span></code>.</li>
<li>Consult the <a class="reference external" href="https://cmake.org/cmake/help/v3.5/module/ExternalProject.html">ExternalProject</a> documentation for more details about <code class="docutils literal notranslate"><span class="pre">externalproject_add()</span></code></li>
</ul>
</li>
<li>The second set of commands adds a library target, which points to the “imported” library file built by the external system. Some properties need to be set in order to add include directories and tell CMake where this file is.</li>
<li>Finally, the generated library is added to <a class="reference external" href="https://cmake.org/cmake/help/v3.5/prop_dir/ADDITIONAL_MAKE_CLEAN_FILES.html">ADDITIONAL_MAKE_CLEAN_FILES</a>. This means <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">clean</span></code> will delete this library. (Note that the other object files from the build won’t be deleted.)</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When using an external build process with PSRAM, remember to add <code class="docutils literal notranslate"><span class="pre">-mfix-esp32-psram-cache-issue</span></code> to the C compiler arguments. See <a class="reference internal" href="../api-reference/kconfig.html#config-spiram-cache-workaround"><span class="std std-ref">CONFIG_SPIRAM_CACHE_WORKAROUND</span></a> for details of this flag.</p>
</div>
<div class="section" id="externalproject-dependencies-clean-builds">
<span id="additional-make-clean-files-note"></span><h4>ExternalProject dependencies, clean builds<a class="headerlink" href="#externalproject-dependencies-clean-builds" title="Permalink to this headline">¶</a></h4>
<p>CMake has some unusual behaviour around external project builds:</p>
<ul>
<li><p class="first"><a class="reference external" href="https://cmake.org/cmake/help/v3.5/prop_dir/ADDITIONAL_MAKE_CLEAN_FILES.html">ADDITIONAL_MAKE_CLEAN_FILES</a> only works when “make” is used as the build system. If <a class="reference external" href="https://ninja-build.org/">Ninja</a> or an IDE build system is used, it won’t delete these files when cleaning.</p>
</li>
<li><p class="first">However, the <a class="reference external" href="https://cmake.org/cmake/help/v3.5/module/ExternalProject.html">ExternalProject</a> configure &amp; build commands will <em>always</em> be re-run after a clean is run.</p>
</li>
<li><p class="first">Therefore, there are two alternative recommended ways to configure the external build command:</p>
<blockquote>
<div><ol class="arabic simple">
<li>Have the external <code class="docutils literal notranslate"><span class="pre">BUILD_COMMAND</span></code> run a full clean compile of all sources. The build command will be run if any of the dependencies passed to <code class="docutils literal notranslate"><span class="pre">externalproject_add</span></code> with <code class="docutils literal notranslate"><span class="pre">DEPENDS</span></code> have changed, or if this is a clean build (ie any of <code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">clean</span></code>, <code class="docutils literal notranslate"><span class="pre">ninja</span> <span class="pre">clean</span></code>, or <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">clean</span></code> was run.)</li>
<li>Have the external <code class="docutils literal notranslate"><span class="pre">BUILD_COMMAND</span></code> be an incremental build command. Pass the parameter <code class="docutils literal notranslate"><span class="pre">BUILD_ALWAYS</span> <span class="pre">1</span></code> to <code class="docutils literal notranslate"><span class="pre">externalproject_add</span></code>. This means the external project will be built each time a build is run, regardless of dependencies. This is only recommended if the external project has correct incremental build behaviour, and doesn’t take too long to run.</li>
</ol>
</div></blockquote>
</li>
</ul>
<p>The best of these approaches for building an external project will depend on the project itself, its build system, and whether you anticipate needing to frequently recompile the project.</p>
</div>
</div>
</div>
<div class="section" id="custom-sdkconfig-defaults">
<span id="id5"></span><h2>Custom sdkconfig defaults<a class="headerlink" href="#custom-sdkconfig-defaults" title="Permalink to this headline">¶</a></h2>
<p>For example projects or other projects where you don’t want to specify a full sdkconfig configuration, but you do want to override some key values from the ESP-IDF defaults, it is possible to create a file <code class="docutils literal notranslate"><span class="pre">sdkconfig.defaults</span></code> in the project directory. This file will be used when creating a new config from scratch, or when any new config value hasn’t yet been set in the <code class="docutils literal notranslate"><span class="pre">sdkconfig</span></code> file.</p>
<p>To override the name of this file or to specify multiple files, set the <code class="docutils literal notranslate"><span class="pre">SDKCONFIG_DEFAULTS</span></code> environment variable or set <code class="docutils literal notranslate"><span class="pre">SDKCONFIG_DEFAULTS</span></code> in top-level CMakeLists.txt. If specifying multiple files, use semicolon as the list separator. File names not specified as full paths are resolved relative to current project.</p>
<div class="section" id="target-dependent-sdkconfig-defaults">
<h3>Target-dependent sdkconfig defaults<a class="headerlink" href="#target-dependent-sdkconfig-defaults" title="Permalink to this headline">¶</a></h3>
<p>In addition to <code class="docutils literal notranslate"><span class="pre">sdkconfig.defaults</span></code> file, build system will also load defaults from <code class="docutils literal notranslate"><span class="pre">sdkconfig.defaults.TARGET_NAME</span></code> file, where <code class="docutils literal notranslate"><span class="pre">TARGET_NAME</span></code> is the value of <code class="docutils literal notranslate"><span class="pre">IDF_TARGET</span></code>. For example, for <code class="docutils literal notranslate"><span class="pre">esp32</span></code> target, default settings will be taken from <code class="docutils literal notranslate"><span class="pre">sdkconfig.defaults</span></code> first, and then from <code class="docutils literal notranslate"><span class="pre">sdkconfig.defaults.esp32</span></code>.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">SDKCONFIG_DEFAULTS</span></code> is used to override the name of defaults file/files, the name of target-specific defaults file will be derived from <code class="docutils literal notranslate"><span class="pre">SDKCONFIG_DEFAULTS</span></code> value/values using the rule above.</p>
</div>
</div>
<div class="section" id="flash-arguments">
<h2>Flash arguments<a class="headerlink" href="#flash-arguments" title="Permalink to this headline">¶</a></h2>
<p>There are some scenarios that we want to flash the target board without IDF. For this case we want to save the built binaries, esptool.py and esptool write_flash arguments. It’s simple to write a script to save binaries and esptool.py.</p>
<p>After running a project build, the build directory contains binary output files (<code class="docutils literal notranslate"><span class="pre">.bin</span></code> files) for the project and also the following flashing data files:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">flash_project_args</span></code> contains arguments to flash the entire project (app, bootloader, partition table, PHY data if this is configured).</li>
<li><code class="docutils literal notranslate"><span class="pre">flash_app_args</span></code> contains arguments to flash only the app.</li>
<li><code class="docutils literal notranslate"><span class="pre">flash_bootloader_args</span></code> contains arguments to flash only the bootloader.</li>
</ul>
<p>You can pass any of these flasher argument files to <code class="docutils literal notranslate"><span class="pre">esptool.py</span></code> as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python esptool.py --chip esp32 write_flash @build/flash_project_args
</pre></div>
</div>
<p>Alternatively, it is possible to manually copy the parameters from the argument file and pass them on the command line.</p>
<p>The build directory also contains a generated file <code class="docutils literal notranslate"><span class="pre">flasher_args.json</span></code> which contains project flash information, in JSON format. This file is used by <code class="docutils literal notranslate"><span class="pre">idf.py</span></code> and can also be used by other tools which need information about the project build.</p>
</div>
<div class="section" id="building-the-bootloader">
<h2>Building the Bootloader<a class="headerlink" href="#building-the-bootloader" title="Permalink to this headline">¶</a></h2>
<p>The bootloader is built by default as part of <code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">build</span></code>, or can be built standalone via <code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">bootloader</span></code>.</p>
<p>The bootloader is a special “subproject” inside <a class="reference external" href="https://github.com/espressif/esp-idf/tree/f91080637//components/bootloader/subproject">/components/bootloader/subproject</a>. It has its own project CMakeLists.txt file and builds separate .ELF and .BIN files to the main project. However it shares its configuration and build directory with the main project.</p>
<p>The subproject is inserted as an external project from the top-level project, by the file <a class="reference external" href="https://github.com/espressif/esp-idf/blob/f91080637//components/bootloader/project_include.cmake">/components/bootloader/project_include.cmake</a>. The main build process runs CMake for the subproject, which includes discovering components (a subset of the main components) and generating a bootloader-specific config (derived from the main <code class="docutils literal notranslate"><span class="pre">sdkconfig</span></code>).</p>
</div>
<div class="section" id="selecting-the-target">
<span id="selecting-idf-target"></span><h2>Selecting the Target<a class="headerlink" href="#selecting-the-target" title="Permalink to this headline">¶</a></h2>
<p>ESP-IDF supports multiple targets (chips). The identifiers used for each chip are as follows:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">esp32</span></code> — for ESP32-D0WD, ESP32-D2WD, ESP32-S0WD (ESP-SOLO), ESP32-U4WD, ESP32-PICO-D4</li>
<li><code class="docutils literal notranslate"><span class="pre">esp32s2</span></code>— for ESP32-S2</li>
</ul>
<p>To select the target before building the project, use <code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">set-target</span> <span class="pre">&lt;target&gt;</span></code> command, for example:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>idf.py set-target esp32s2
</pre></div>
</div>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last"><code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">set-target</span></code> will clear the build directory and re-generate the <code class="docutils literal notranslate"><span class="pre">sdkconfig</span></code> file from scratch. The old <code class="docutils literal notranslate"><span class="pre">sdkconfig</span></code> file will be saved as <code class="docutils literal notranslate"><span class="pre">sdkconfig.old</span></code>.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The behavior of <code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">set-target</span></code> command is equivalent to:</p>
<ol class="last arabic simple">
<li>clearing the build directory (<code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">fullclean</span></code>)</li>
<li>removing the sdkconfig file (<code class="docutils literal notranslate"><span class="pre">mv</span> <span class="pre">sdkconfig</span> <span class="pre">sdkconfig.old</span></code>)</li>
<li>configuring the project with the new target (<code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">-DIDF_TARGET=esp32</span> <span class="pre">reconfigure</span></code>)</li>
</ol>
</div>
<p>It is also possible to pass the desired <code class="docutils literal notranslate"><span class="pre">IDF_TARGET</span></code> as an environement variable (e.g. <code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">IDF_TARGET=esp32s2</span></code>) or as a CMake variable (e.g. <code class="docutils literal notranslate"><span class="pre">-DIDF_TARGET=esp32s2</span></code> argument to CMake or idf.py). Setting the environment variable is a convenient method if you mostly work with one type of the chip.</p>
<p>To specify the _default_ value of <code class="docutils literal notranslate"><span class="pre">IDF_TARGET</span></code> for a given project, add <code class="docutils literal notranslate"><span class="pre">CONFIG_IDF_TARGET</span></code> value to <code class="docutils literal notranslate"><span class="pre">sdkconfig.defaults</span></code>. For example, <code class="docutils literal notranslate"><span class="pre">CONFIG_IDF_TARGET=&quot;esp32s2&quot;</span></code>. This value will be used if <code class="docutils literal notranslate"><span class="pre">IDF_TARGET</span></code> is not specified by other method: using an environment variable, CMake variable, or <code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">set-target</span></code> command.</p>
<p>If the target has not been set by any of these methods, the build system will default to <code class="docutils literal notranslate"><span class="pre">esp32</span></code> target.</p>
</div>
<div class="section" id="writing-pure-cmake-components">
<h2>Writing Pure CMake Components<a class="headerlink" href="#writing-pure-cmake-components" title="Permalink to this headline">¶</a></h2>
<p>The ESP-IDF build system “wraps” CMake with the concept of “components”, and helper functions to automatically integrate these components into a project build.</p>
<p>However, underneath the concept of “components” is a full CMake build system. It is also possible to make a component which is pure CMake.</p>
<p>Here is an example minimal “pure CMake” component CMakeLists file for a component named <code class="docutils literal notranslate"><span class="pre">json</span></code>:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">add_library</span><span class="p">(</span><span class="s">json</span> <span class="s">STATIC</span>
<span class="s">cJSON/cJSON.c</span>
<span class="s">cJSON/cJSON_Utils.c</span><span class="p">)</span>

<span class="nb">target_include_directories</span><span class="p">(</span><span class="s">json</span> <span class="s">PUBLIC</span> <span class="s">cJSON</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li>This is actually an equivalent declaration to the IDF <code class="docutils literal notranslate"><span class="pre">json</span></code> component <a class="reference external" href="https://github.com/espressif/esp-idf/blob/f91080637//components/json/CMakeLists.txt">/components/json/CMakeLists.txt</a>.</li>
<li>This file is quite simple as there are not a lot of source files. For components with a large number of files, the globbing behaviour of ESP-IDF’s component logic can make the component CMakeLists style simpler.)</li>
<li>Any time a component adds a library target with the component name, the ESP-IDF build system will automatically add this to the build, expose public include directories, etc. If a component wants to add a library target with a different name, dependencies will need to be added manually via CMake commands.</li>
</ul>
</div>
<div class="section" id="using-third-party-cmake-projects-with-components">
<h2>Using Third-Party CMake Projects with Components<a class="headerlink" href="#using-third-party-cmake-projects-with-components" title="Permalink to this headline">¶</a></h2>
<p>CMake is used for a lot of open-source C and C++ projects — code that users can tap into for their applications. One of the benefits of having a CMake build system
is the ability to import these third-party projects, sometimes even without modification! This allows for users to be able to get functionality that may
not yet be provided by a component, or use another library for the same functionality.</p>
<p>Importing a library might look like this for a hypothetical library <code class="docutils literal notranslate"><span class="pre">foo</span></code> to be used in the <code class="docutils literal notranslate"><span class="pre">main</span></code> component:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># Register the component</span>
<span class="nb">idf_component_register</span><span class="p">(</span><span class="s">...</span><span class="p">)</span>

<span class="c"># Set values of hypothetical variables that control the build of `foo`</span>
<span class="nb">set</span><span class="p">(</span><span class="s">FOO_BUILD_STATIC</span> <span class="s">OFF</span><span class="p">)</span>
<span class="nb">set</span><span class="p">(</span><span class="s">FOO_BUILD_TESTS</span> <span class="s">OFF</span><span class="p">)</span>

<span class="c"># Create and import the library targets</span>
<span class="nb">add_subdirectory</span><span class="p">(</span><span class="s">foo</span><span class="p">)</span>

<span class="c"># Publicly link `foo` to `main` component</span>
<span class="nb">target_link_libraries</span><span class="p">(</span><span class="s">main</span> <span class="s">PUBLIC</span> <span class="s">foo</span><span class="p">)</span>
</pre></div>
</div>
<p>For an actual example, take a look at <a class="reference external" href="https://github.com/espressif/esp-idf/tree/f91080637/examples/build_system/cmake/import_lib">build_system/cmake/import_lib</a>. Take note that what needs to be done in order to import
the library may vary. It is recommended to read up on the library’s documentation for instructions on how to
import it from other projects. Studying the library’s CMakeLists.txt and build structure can also be helpful.</p>
<p>It is also possible to wrap a third-party library to be used as a component in this manner. For example, the <a class="reference external" href="https://github.com/espressif/esp-idf/tree/f91080637/components/mbedtls">mbedtls</a> component is a wrapper for
Espressif’s fork of <a class="reference external" href="https://github.com/ARMmbed/mbedtls">mbedtls</a>. See its <a class="reference external" href="https://github.com/espressif/esp-idf/blob/f91080637/components/mbedtls/CMakeLists.txt">component CMakeLists.txt </a>.</p>
<p>The CMake variable <code class="docutils literal notranslate"><span class="pre">ESP_PLATFORM</span></code> is set to 1 whenever the ESP-IDF build system is being used. Tests such as <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">(ESP_PLATFORM)</span></code> can be used in generic CMake code if special IDF-specific logic is required.</p>
<div class="section" id="using-esp-idf-components-from-external-libraries">
<h3>Using ESP-IDF components from external libraries<a class="headerlink" href="#using-esp-idf-components-from-external-libraries" title="Permalink to this headline">¶</a></h3>
<p>The above example assumes that the external library <code class="docutils literal notranslate"><span class="pre">foo`</span> <span class="pre">(or</span> <span class="pre">``tinyxml</span></code> in the case of the <code class="docutils literal notranslate"><span class="pre">import_lib</span></code> example) doesn’t need to use any ESP-IDF APIs apart from common APIs such as libc, libstdc++, etc. If the external library needs to use APIs provided by other ESP-IDF components, this needs to be specified in the external CMakeLists.txt file by adding a dependency on the library target <code class="docutils literal notranslate"><span class="pre">idf::&lt;componentname&gt;</span></code>.</p>
<p>For example, in the <code class="docutils literal notranslate"><span class="pre">foo/CMakeLists.txt</span></code> file:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">add_library</span><span class="p">(</span><span class="s">foo</span> <span class="s">bar.c</span> <span class="s">fizz.cpp</span> <span class="s">buzz.cpp</span><span class="p">)</span>

<span class="nb">if</span><span class="p">(</span><span class="s">ESP_PLATFORM</span><span class="p">)</span>
  <span class="c"># On ESP-IDF, bar.c needs to include esp_spi_flash.h from the spi_flash component</span>
  <span class="nb">target_link_libraries</span><span class="p">(</span><span class="s">foo</span> <span class="s">PRIVATE</span> <span class="s">idf::spi_flash</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="using-prebuilt-libraries-with-components">
<h2>Using Prebuilt Libraries with Components<a class="headerlink" href="#using-prebuilt-libraries-with-components" title="Permalink to this headline">¶</a></h2>
<p>Another possibility is that you have a prebuilt static library (<code class="docutils literal notranslate"><span class="pre">.a</span></code> file), built by some other build process.</p>
<p>The ESP-IDF build system provides a utility function <code class="docutils literal notranslate"><span class="pre">add_prebuilt_library</span></code> for users to be able to easily import and use
prebuilt libraries:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">add_prebuilt_library</span><span class="p">(</span><span class="s">target_name</span> <span class="s">lib_path</span> <span class="s">[REQUIRES</span> <span class="s">req1</span> <span class="s">req2</span> <span class="s">...]</span> <span class="s">[PRIV_REQUIRES</span> <span class="s">req1</span> <span class="s">req2</span> <span class="s">...]</span><span class="p">)</span>
</pre></div>
</div>
<p>where:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">target_name</span></code>- name that can be used to reference the imported library, such as when linking to other targets</li>
<li><code class="docutils literal notranslate"><span class="pre">lib_path</span></code>- path to prebuilt library; may be an absolute or relative path to the component directory</li>
</ul>
<p>Optional arguments <code class="docutils literal notranslate"><span class="pre">REQUIRES</span></code> and <code class="docutils literal notranslate"><span class="pre">PRIV_REQUIRES</span></code> specify dependency on other components. These have the same meaning as the arguments for <code class="docutils literal notranslate"><span class="pre">idf_component_register</span></code>.</p>
<p>Take note that the prebuilt library must have been compiled for the same target as the consuming project. Configuration relevant to the prebuilt
library must also match. If not paid attention to, these two factors may contribute to subtle bugs in the app.</p>
<p>For an example, take a look at <a class="reference external" href="https://github.com/espressif/esp-idf/tree/f91080637/examples/build_system/cmake/import_prebuilt">build_system/cmake/import_prebuilt</a>.</p>
</div>
<div class="section" id="using-esp-idf-in-custom-cmake-projects">
<h2>Using ESP-IDF in Custom CMake Projects<a class="headerlink" href="#using-esp-idf-in-custom-cmake-projects" title="Permalink to this headline">¶</a></h2>
<p>ESP-IDF provides a template CMake project for easily creating an application. However, in some instances the user might already
have an existing CMake project or may want to create a custom one. In these cases it is desirable to be able to consume IDF components
as libraries to be linked to the user’s targets (libraries/ executables).</p>
<p>It is possible to do so by using the <a class="reference internal" href="#cmake-buildsystem-api"><span class="std std-ref">build system APIs provided</span></a> by <a class="reference external" href="https://github.com/espressif/esp-idf/blob/f91080637/tools/cmake/idf.cmake">tools/cmake/idf.cmake</a>. For example:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span> <span class="s">3.5</span><span class="p">)</span>
<span class="nb">project</span><span class="p">(</span><span class="s">my_custom_app</span> <span class="s">C</span><span class="p">)</span>

<span class="c"># Include CMake file that provides ESP-IDF CMake build system APIs.</span>
<span class="nb">include</span><span class="p">(</span><span class="o">$ENV{</span><span class="nv">IDF_PATH</span><span class="o">}</span><span class="s">/tools/cmake/idf.cmake</span><span class="p">)</span>

<span class="c"># Include ESP-IDF components in the build, may be thought as an equivalent of</span>
<span class="c"># add_subdirectory() but with some additional procesing and magic for ESP-IDF build</span>
<span class="c"># specific build processes.</span>
<span class="nb">idf_build_process</span><span class="p">(</span><span class="s">esp32</span><span class="p">)</span>

<span class="c"># Create the project executable and plainly link the newlib component to it using</span>
<span class="c"># its alias, idf::newlib.</span>
<span class="nb">add_executable</span><span class="p">(</span><span class="o">${</span><span class="nv">CMAKE_PROJECT_NAME</span><span class="o">}</span><span class="s">.elf</span> <span class="s">main.c</span><span class="p">)</span>
<span class="nb">target_link_libraries</span><span class="p">(</span><span class="o">${</span><span class="nv">CMAKE_PROJECT_NAME</span><span class="o">}</span><span class="s">.elf</span> <span class="s">idf::newlib</span><span class="p">)</span>

<span class="c"># Let the build system know what the project executable is to attach more targets, dependencies, etc.</span>
<span class="nb">idf_build_executable</span><span class="p">(</span><span class="o">${</span><span class="nv">CMAKE_PROJECT_NAME</span><span class="o">}</span><span class="s">.elf</span><span class="p">)</span>
</pre></div>
</div>
<p>The example in <a class="reference external" href="https://github.com/espressif/esp-idf/tree/f91080637/examples/build_system/cmake/idf_as_lib">build_system/cmake/idf_as_lib</a> demonstrates the creation of an application equivalent to <a class="reference external" href="https://github.com/espressif/esp-idf/tree/f91080637/examples/get-started/hello_world">hello world application </a>
using a custom CMake project.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The IDF build system can only set compiler flags for source files that it builds. When an external CMakeLists.txt file is used and PSRAM is enabled, remember to add <code class="docutils literal notranslate"><span class="pre">-mfix-esp32-psram-cache-issue</span></code> to the C compiler arguments. See <a class="reference internal" href="../api-reference/kconfig.html#config-spiram-cache-workaround"><span class="std std-ref">CONFIG_SPIRAM_CACHE_WORKAROUND</span></a> for details of this flag.</p>
</div>
</div>
<div class="section" id="esp-idf-cmake-build-system-api">
<span id="cmake-buildsystem-api"></span><h2>ESP-IDF CMake Build System API<a class="headerlink" href="#esp-idf-cmake-build-system-api" title="Permalink to this headline">¶</a></h2>
<div class="section" id="idf-build-commands">
<h3>idf-build-commands<a class="headerlink" href="#idf-build-commands" title="Permalink to this headline">¶</a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>idf_build_get_property(var property [GENERATOR_EXPRESSION])
</pre></div>
</div>
<p>Retrieve a <a class="reference internal" href="#cmake-build-properties"><span class="std std-ref">build property</span></a> <em>property</em> and store it in <em>var</em> accessible from the current scope. Specifying
<em>GENERATOR_EXPRESSION</em> will retrieve the generator expression string for that property, instead of the actual value, which
can be used with CMake commands that support generator expressions.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>idf_build_set_property(property val [APPEND])
</pre></div>
</div>
<p>Set a <a class="reference internal" href="#cmake-build-properties"><span class="std std-ref">build property</span></a> <em>property</em> with value <em>val</em>. Specifying <em>APPEND</em> will append the specified value to the current
value of the property. If the property does not previously exist or it is currently empty, the specified value becomes
the first element/member instead.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>idf_build_component(component_dir)
</pre></div>
</div>
<p>Present a directory <em>component_dir</em> that contains a component to the build system. Relative paths are converted to absolute paths with respect to current directory.
All calls to this command must be performed before <cite>idf_build_process</cite>.</p>
<p>This command does not guarantee that the component will be processed during build (see the <cite>COMPONENTS</cite> argument description for <cite>idf_build_process</cite>)</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>idf_build_process(target
                  [PROJECT_DIR project_dir]
                  [PROJECT_VER project_ver]
                  [PROJECT_NAME project_name]
                  [SDKCONFIG sdkconfig]
                  [SDKCONFIG_DEFAULTS sdkconfig_defaults]
                  [BUILD_DIR build_dir]
                  [COMPONENTS component1 component2 ...])
</pre></div>
</div>
<p>Performs the bulk of the behind-the-scenes magic for including ESP-IDF components such as component configuration, libraries creation,
dependency expansion and resolution. Among these functions, perhaps the most important
from a user’s perspective is the libraries creation by calling each component’s <code class="docutils literal notranslate"><span class="pre">idf_component_register</span></code>. This command creates the libraries for each component, which are accessible using aliases in the form
idf::<em>component_name</em>. These aliases can be used to link the components to the user’s own targets, either libraries
or executables.</p>
<p>The call requires the target chip to be specified with <em>target</em> argument. Optional arguments for the call include:</p>
<ul class="simple">
<li>PROJECT_DIR - directory of the project; defaults to CMAKE_SOURCE_DIR</li>
<li>PROJECT_NAME - name of the project; defaults to CMAKE_PROJECT_NAME</li>
<li>PROJECT_VER - version/revision of the project; defaults to “1”</li>
<li>SDKCONFIG - output path of generated sdkconfig file; defaults to PROJECT_DIR/sdkconfig or CMAKE_SOURCE_DIR/sdkconfig depending if PROJECT_DIR is set</li>
<li>SDKCONFIG_DEFAULTS - list of files containing default config to use in the build (list must contain full paths); defaults to empty. For each value <em>filename</em> in the list, the config from file <em>filename.target</em>, if it exists, is also loaded.</li>
<li>BUILD_DIR - directory to place ESP-IDF build-related artifacts, such as generated binaries, text files, components; defaults to CMAKE_BINARY_DIR</li>
<li>COMPONENTS - select components to process among the components known by the build system (added via <cite>idf_build_component</cite>). This argument is used to trim the build.
Other components are automatically added if they are required in the dependency chain, i.e.
the public and private requirements of the components in this list are automatically added, and in turn the public and private requirements of those requirements,
so on and so forth. If not specified, all components known to the build system are processed.</li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>idf_build_executable(executable)
</pre></div>
</div>
<p>Specify the executable <em>executable</em> for ESP-IDF build. This attaches additional targets such as dependencies related to
flashing, generating additional binary files, etc. Should be called after <code class="docutils literal notranslate"><span class="pre">idf_build_process</span></code>.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>idf_build_get_config(var config [GENERATOR_EXPRESSION])
</pre></div>
</div>
<p>Get the value of the specified config. Much like build properties, specifying
<em>GENERATOR_EXPRESSION</em> will retrieve the generator expression string for that config, instead of the actual value, which
can be used with CMake commands that support generator expressions. Actual config values are only known after call to <cite>idf_build_process</cite>, however.</p>
</div>
<div class="section" id="cmake-build-properties">
<span id="idf-build-properties"></span><h3>idf-build-properties<a class="headerlink" href="#cmake-build-properties" title="Permalink to this headline">¶</a></h3>
<p>These are properties that describe the build. Values of build properties can be retrieved by using the build command <code class="docutils literal notranslate"><span class="pre">idf_build_get_property</span></code>.
For example, to get the Python interpreter used for the build:</p>
</div>
<div class="section" id="idf-component-commands">
<h3>idf-component-commands<a class="headerlink" href="#idf-component-commands" title="Permalink to this headline">¶</a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>idf_component_get_property(var component property [GENERATOR_EXPRESSION])
</pre></div>
</div>
<p>Retrieve a specified <em>component</em>’s <a class="reference internal" href="#cmake-component-properties"><span class="std std-ref">component property</span></a>, <em>property</em> and store it in <em>var</em> accessible from the current scope. Specifying
<em>GENERATOR_EXPRESSION</em> will retrieve the generator expression string for that property, instead of the actual value, which
can be used with CMake commands that support generator expressions.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>idf_component_set_property(component property val [APPEND])
</pre></div>
</div>
<p>Set a specified <em>component</em>’s <a class="reference internal" href="#cmake-component-properties"><span class="std std-ref">component property</span></a>, <em>property</em> with value <em>val</em>. Specifying <em>APPEND</em> will append the specified value to the current
value of the property. If the property does not previously exist or it is currently empty, the specified value becomes
the first element/member instead.</p>
<div class="highlight-none notranslate" id="cmake-component-register"><div class="highlight"><pre><span></span>idf_component_register([[SRCS src1 src2 ...] | [[SRC_DIRS dir1 dir2 ...] [EXCLUDE_SRCS src1 src2 ...]]
                       [INCLUDE_DIRS dir1 dir2 ...]
                       [PRIV_INCLUDE_DIRS dir1 dir2 ...]
                       [REQUIRES component1 component2 ...]
                       [PRIV_REQUIRES component1 component2 ...]
                       [LDFRAGMENTS ldfragment1 ldfragment2 ...]
                       [REQUIRED_IDF_TARGETS target1 target2 ...]
                       [EMBED_FILES file1 file2 ...]
                       [EMBED_TXTFILES file1 file2 ...])
</pre></div>
</div>
<p>Register a component to the build system. Much like the <code class="docutils literal notranslate"><span class="pre">project()</span></code> CMake command, this should be called from the component’s
CMakeLists.txt directly (not through a function or macro) and is recommended to be called before any other command. Here are some
guidelines on what commands can <strong>not</strong> be called before <code class="docutils literal notranslate"><span class="pre">idf_component_register</span></code>:</p>
<blockquote>
<div><ul class="simple">
<li>commands that are not valid in CMake script mode</li>
<li>custom commands defined in project_include.cmake</li>
<li>build system API commands except <code class="docutils literal notranslate"><span class="pre">idf_build_get_property</span></code>; although consider whether the property may not have been set yet</li>
</ul>
</div></blockquote>
<p>Commands that set and operate on variables are generally okay to call before <code class="docutils literal notranslate"><span class="pre">idf_component_register</span></code>.</p>
<p>The arguments for <code class="docutils literal notranslate"><span class="pre">idf_component_register</span></code> include:</p>
<blockquote>
<div><ul class="simple">
<li>SRCS - component source files used for creating a static library for the component; if not specified, component is a treated as a
config-only component and an interface library is created instead.</li>
<li>SRC_DIRS, EXCLUDE_SRCS - used to glob source files (.c, .cpp, .S) by specifying directories, instead of specifying source files manually via SRCS. Note that this is subject to the <a class="reference internal" href="#cmake-file-globbing"><span class="std std-ref">limitations of globbing in CMake</span></a>. Source files specified in EXCLUDE_SRCS are removed from the globbed files.</li>
<li>INCLUDE_DIRS - paths, relative to the component directory, which will be added to the include search path for all other components which require the current component</li>
<li>PRIV_INCLUDE_DIRS - directory paths, must be relative to the component directory, which will be added to the include search path for this component’s source files only</li>
<li>REQUIRES - public component requirements for the component</li>
<li>PRIV_REQUIRES - private component requirements for the component; ignored on config-only components</li>
<li>LDFRAGMENTS - component linker fragment files</li>
<li>REQUIRED_IDF_TARGETS - specify the only target the component supports</li>
</ul>
</div></blockquote>
<p>The following are used for <a class="reference internal" href="#cmake-embed-data"><span class="std std-ref">embedding data into the component</span></a>, and is considered as source files
when determining if a component is config-only. This means that even if the component does not specify source files, a static library is still
created internally for the component if it specifies either:</p>
<blockquote>
<div><ul class="simple">
<li>EMBED_FILES - binary files to be embedded in the component</li>
<li>EMBED_TXTFILES - text files to be embedded in the component</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="cmake-component-properties">
<span id="idf-component-properties"></span><h3>idf-component-properties<a class="headerlink" href="#cmake-component-properties" title="Permalink to this headline">¶</a></h3>
<p>These are properties that describe a component. Values of component properties can be retrieved by using the build command <code class="docutils literal notranslate"><span class="pre">idf_component_get_property</span></code>.
For example, to get the directory of the <code class="docutils literal notranslate"><span class="pre">freertos</span></code> component:</p>
<ul class="simple">
<li>COMPONENT_ALIAS - alias for COMPONENT_LIB used for linking the component to external targets; set by <code class="docutils literal notranslate"><span class="pre">idf_build_component</span></code> and alias library itself
is created by <code class="docutils literal notranslate"><span class="pre">idf_component_register</span></code></li>
<li>COMPONENT_DIR - component directory; set by <code class="docutils literal notranslate"><span class="pre">idf_build_component</span></code></li>
<li>COMPONENT_LIB - name for created component static/interface library; set by <code class="docutils literal notranslate"><span class="pre">idf_build_component</span></code> and library itself
is created by <code class="docutils literal notranslate"><span class="pre">idf_component_register</span></code></li>
<li>COMPONENT_NAME - name of the component; set by <code class="docutils literal notranslate"><span class="pre">idf_build_component</span></code> based on the component directory name</li>
<li>COMPONENT_TYPE - type of the component, whether LIBRARY or CONFIG_ONLY. A component is of type LIBRARY if it specifies
source files or embeds a file</li>
<li>EMBED_FILES - list of files to embed in component; set from <code class="docutils literal notranslate"><span class="pre">idf_component_register</span></code> EMBED_FILES argument</li>
<li>EMBED_TXTFILES - list of text files to embed in component; set from <code class="docutils literal notranslate"><span class="pre">idf_component_register</span></code> EMBED_TXTFILES argument</li>
<li>INCLUDE_DIRS - list of component include directories; set from <code class="docutils literal notranslate"><span class="pre">idf_component_register</span></code> INCLUDE_DIRS argument</li>
<li>KCONFIG - component Kconfig file; set by <code class="docutils literal notranslate"><span class="pre">idf_build_component</span></code></li>
<li>KCONFIG_PROJBUILD - component Kconfig.projbuild; set by <code class="docutils literal notranslate"><span class="pre">idf_build_component</span></code></li>
<li>LDFRAGMENTS - list of component linker fragment files; set from <code class="docutils literal notranslate"><span class="pre">idf_component_register</span></code> LDFRAGMENTS argument</li>
<li>PRIV_INCLUDE_DIRS - list of component private include directories; set from <code class="docutils literal notranslate"><span class="pre">idf_component_register</span></code> PRIV_INCLUDE_DIRS on components of type LIBRARY</li>
<li>PRIV_REQUIRES - list of private component dependentices; set from <code class="docutils literal notranslate"><span class="pre">idf_component_register</span></code> PRIV_REQUIRES argument</li>
<li>REQUIRED_IDF_TARGETS - list of targets the component supports; set from <code class="docutils literal notranslate"><span class="pre">idf_component_register</span></code> EMBED_TXTFILES argument</li>
<li>REQUIRES - list of public component dependencies; set from <code class="docutils literal notranslate"><span class="pre">idf_component_register</span></code> REQUIRES argument</li>
<li>SRCS - list of component source files; set from SRCS or SRC_DIRS/EXCLUDE_SRCS argument of <code class="docutils literal notranslate"><span class="pre">idf_component_register</span></code></li>
</ul>
</div>
</div>
<div class="section" id="file-globbing-incremental-builds">
<span id="cmake-file-globbing"></span><h2>File Globbing &amp; Incremental Builds<a class="headerlink" href="#file-globbing-incremental-builds" title="Permalink to this headline">¶</a></h2>
<p>The preferred way to include source files in an ESP-IDF component is to list them manually via SRCS argument to <code class="docutils literal notranslate"><span class="pre">idf_component_register</span></code>:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">idf_component_register</span><span class="p">(</span><span class="s">SRCS</span> <span class="s">library/a.c</span> <span class="s">library/b.c</span> <span class="s">platform/platform.c</span>
                       <span class="s">...</span><span class="p">)</span>
</pre></div>
</div>
<p>This preference reflects the <a class="reference external" href="https://gist.github.com/mbinna/c61dbb39bca0e4fb7d1f73b0d66a4fd1/">CMake best practice</a> of manually listing source files. This could, however, be inconvenient when there are lots of source files to add to the build. The ESP-IDF build system provides an alternative way for specifying source files using <code class="docutils literal notranslate"><span class="pre">SRC_DIRS</span></code>:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">idf_component_register</span><span class="p">(</span><span class="s">SRC_DIRS</span> <span class="s">library</span> <span class="s">platform</span>
                       <span class="s">...</span><span class="p">)</span>
</pre></div>
</div>
<p>This uses globbing behind the scenes to find source files in the specified directories. Be aware, however, that if a new source file is added and this method is used, then CMake won’t know to automatically re-run and this file won’t be added to the build.</p>
<p>The trade-off is acceptable when you’re adding the file yourself, because you can trigger a clean build or run <code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">reconfigure</span></code> to manually re-run <a class="reference external" href="https://cmake.org/">CMake</a>. However, the problem gets harder when you share your project with others who may check out a new version using a source control tool like Git…</p>
<p>For components which are part of ESP-IDF, we use a third party Git CMake integration module (<a class="reference external" href="https://github.com/espressif/esp-idf/blob/f91080637//tools/cmake/third_party/GetGitRevisionDescription.cmake">/tools/cmake/third_party/GetGitRevisionDescription.cmake</a>) which automatically re-runs CMake any time the repository commit changes. This means if you check out a new ESP-IDF version, CMake will automatically rerun.</p>
<p>For project components (not part of ESP-IDF), there are a few different options:</p>
<ul class="simple">
<li>If keeping your project file in Git, ESP-IDF will automatically track the Git revision and re-run CMake if the revision changes.</li>
<li>If some components are kept in a third git repository (not the project repository or ESP-IDF repository), you can add a call to the <code class="docutils literal notranslate"><span class="pre">git_describe</span></code> function in a component CMakeLists file in order to automatically trigger re-runs of CMake when the Git revision changes.</li>
<li>If not using Git, remember to manually run <code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">reconfigure</span></code> whenever a source file may change.</li>
<li>To avoid this problem entirely, use <code class="docutils literal notranslate"><span class="pre">SRCS</span></code> argument to <code class="docutils literal notranslate"><span class="pre">idf_component_register</span></code> to list all source files in project components.</li>
</ul>
<p>The best option will depend on your particular project and its users.</p>
</div>
<div class="section" id="build-system-metadata">
<h2>Build System Metadata<a class="headerlink" href="#build-system-metadata" title="Permalink to this headline">¶</a></h2>
<p>For integration into IDEs and other build systems, when CMake runs the build process generates a number of metadata files in the <code class="docutils literal notranslate"><span class="pre">build/</span></code> directory. To regenerate these files, run <code class="docutils literal notranslate"><span class="pre">cmake</span></code> or <code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">reconfigure</span></code> (or any other <code class="docutils literal notranslate"><span class="pre">idf.py</span></code> build command).</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">compile_commands.json</span></code> is a standard format JSON file which describes every source file which is compiled in the project. A CMake feature generates this file, and many IDEs know how to parse it.</li>
<li><code class="docutils literal notranslate"><span class="pre">project_description.json</span></code> contains some general information about the ESP-IDF project, configured paths, etc.</li>
<li><code class="docutils literal notranslate"><span class="pre">flasher_args.json</span></code> contains esptool.py arguments to flash the project’s binary files. There are also <code class="docutils literal notranslate"><span class="pre">flash_*_args</span></code> files which can be used directly with esptool.py. See <a class="reference internal" href="#flash-arguments">Flash arguments</a>.</li>
<li><code class="docutils literal notranslate"><span class="pre">CMakeCache.txt</span></code> is the CMake cache file which contains other information about the CMake process, toolchain, etc.</li>
<li><code class="docutils literal notranslate"><span class="pre">config/sdkconfig.json</span></code> is a JSON-formatted version of the project configuration values.</li>
<li><code class="docutils literal notranslate"><span class="pre">config/kconfig_menus.json</span></code> is a JSON-formatted version of the menus shown in menuconfig, for use in external IDE UIs.</li>
</ul>
<div class="section" id="json-configuration-server">
<h3>JSON Configuration Server<a class="headerlink" href="#json-configuration-server" title="Permalink to this headline">¶</a></h3>
<p>A tool called <code class="docutils literal notranslate"><span class="pre">confserver.py</span></code> is provided to allow IDEs to easily integrate with the configuration system logic. <code class="docutils literal notranslate"><span class="pre">confserver.py</span></code> is designed to run in the background and interact with a calling process by reading and writing JSON over process stdin &amp; stdout.</p>
<p>You can run <code class="docutils literal notranslate"><span class="pre">confserver.py</span></code> from a project via <code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">confserver</span></code> or <code class="docutils literal notranslate"><span class="pre">ninja</span> <span class="pre">confserver</span></code>, or a similar target triggered from a different build generator.</p>
<p>The config server outputs human-readable errors and warnings on stderr and JSON on stdout. On startup, it will output the full values of each configuration item in the system as a JSON dictionary, and the available ranges for values which are range constrained. The same information is contained in <code class="docutils literal notranslate"><span class="pre">sdkconfig.json</span></code>:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&quot;values&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;ITEM&quot;</span><span class="p">:</span> <span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="nt">&quot;ITEM_2&quot;</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span> <span class="nt">&quot;ITEM_3&quot;</span><span class="p">:</span> <span class="kc">false</span> <span class="p">},</span> <span class="nt">&quot;ranges&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;ITEM_2&quot;</span> <span class="p">:</span> <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">32768</span> <span class="p">]</span> <span class="p">}</span> <span class="p">}</span>
</pre></div>
</div>
<p>Only visible configuration items are sent. Invisible/disabled items can be parsed from the static <code class="docutils literal notranslate"><span class="pre">kconfig_menus.json</span></code> file which also contains the menu structure and other metadata (descriptions, types, ranges, etc.)</p>
<p>The Configuration Server will then wait for input from the client. The client passes a request to change one or more values, as a JSON object followed by a newline:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="nt">&quot;set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;SOME_NAME&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nt">&quot;OTHER_NAME&quot;</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}</span> <span class="p">}</span>
</pre></div>
</div>
<p>The Configuration Server will parse this request, update the project <code class="docutils literal notranslate"><span class="pre">sdkconfig</span></code> file, and return a full list of changes:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&quot;values&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;SOME_NAME&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nt">&quot;OTHER_NAME&quot;</span><span class="p">:</span> <span class="kc">true</span> <span class="p">,</span> <span class="nt">&quot;DEPENDS_ON_SOME_NAME&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">}}</span>
</pre></div>
</div>
<p>Items which are now invisible/disabled will return value <code class="docutils literal notranslate"><span class="pre">null</span></code>. Any item which is newly visible will return its newly visible current value.</p>
<p>If the range of a config item changes, due to conditional range depending on another value, then this is also sent:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&quot;values&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;OTHER_NAME&quot;</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span> <span class="nt">&quot;ranges&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;HAS_RANGE&quot;</span> <span class="p">:</span> <span class="p">[</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span> <span class="p">]</span> <span class="p">}</span> <span class="p">}</span>
</pre></div>
</div>
<p>If invalid data is passed, an “error” field is present on the object:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&quot;values&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="nt">&quot;error&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;The following config symbol(s) were not visible so were not updated: NOT_VISIBLE_ITEM&quot;</span><span class="p">]}</span>
</pre></div>
</div>
<p>By default, no config changes are written to the sdkconfig file. Changes are held in memory until a “save” command is sent:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&quot;save&quot;</span><span class="p">:</span> <span class="kc">null</span> <span class="p">}</span>
</pre></div>
</div>
<p>To reload the config values from a saved file, discarding any changes in memory, a “load” command can be sent:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&quot;load&quot;</span><span class="p">:</span> <span class="kc">null</span> <span class="p">}</span>
</pre></div>
</div>
<p>The value for both “load” and “save” can be a new pathname, or “null” to load/save the previous pathname.</p>
<p>The response to a “load” command is always the full set of config values and ranges, the same as when the server is initially started.</p>
<p>Any combination of “load”, “set”, and “save” can be sent in a single command and commands are executed in that order. Therefore it’s possible to load config from a file, set some config item values and then save to a file in a single command.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The configuration server does not automatically load any changes which are applied externally to the <code class="docutils literal notranslate"><span class="pre">sdkconfig</span></code> file. Send a “load” command or restart the server if the file is externally edited.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The configuration server does not re-run CMake to regenerate other build files or metadata files after <code class="docutils literal notranslate"><span class="pre">sdkconfig</span></code> is updated. This will happen automatically the next time <code class="docutils literal notranslate"><span class="pre">CMake</span></code> or <code class="docutils literal notranslate"><span class="pre">idf.py</span></code> is run.</p>
</div>
</div>
</div>
<div class="section" id="build-system-internals">
<h2>Build System Internals<a class="headerlink" href="#build-system-internals" title="Permalink to this headline">¶</a></h2>
<div class="section" id="build-scripts">
<h3>Build Scripts<a class="headerlink" href="#build-scripts" title="Permalink to this headline">¶</a></h3>
<p>The listfiles for the ESP-IDF build system reside in <a class="reference external" href="https://github.com/espressif/esp-idf/tree/f91080637//tools/cmake">/tools/cmake</a>. The modules which implement core build system functionality are as follows:</p>
<blockquote>
<div><blockquote>
<div><ul class="simple">
<li>build.cmake - Build related commands i.e. build initialization, retrieving/setting build properties, build processing.</li>
<li>component.cmake - Component related commands i.e. adding components, retrieving/setting component properties, registering components.</li>
<li>kconfig.cmake - Generation of configuration files (sdkconfig, sdkconfig.h, sdkconfig.cmake, etc.) from Kconfig files.</li>
<li>ldgen.cmake - Generation  of  final linker script from linker fragment files.</li>
<li>target.cmake - Setting build target and toolchain file.</li>
<li>utilities.cmake - Miscellaneous helper commands.</li>
</ul>
</div></blockquote>
<p>Aside from these files, there are two other important CMake scripts in <a class="reference external" href="https://github.com/espressif/esp-idf/tree/f91080637//tools/cmake">/tools/cmake</a>:</p>
<blockquote>
<div><ul class="simple">
<li>idf.cmake - Sets up the build and includes the core modules listed above. Included in CMake projects in order to access ESP-IDF build system functionality.</li>
<li>project.cmake - Includes <code class="docutils literal notranslate"><span class="pre">idf.cmake</span></code> and provides a custom <code class="docutils literal notranslate"><span class="pre">project()</span></code> command that takes care of all the heavy lifting of building an executable. Included in the top-level CMakeLists.txt of standard ESP-IDF projects.</li>
</ul>
</div></blockquote>
</div></blockquote>
<p>The rest of the files in <a class="reference external" href="https://github.com/espressif/esp-idf/tree/f91080637//tools/cmake">/tools/cmake</a> are support or third-party scripts used in the build process.</p>
</div>
<div class="section" id="build-process">
<h3>Build Process<a class="headerlink" href="#build-process" title="Permalink to this headline">¶</a></h3>
<p>This section describes the standard ESP-IDF application build process. The build process can be broken down roughly into four phases:</p>
<div class="figure align-center" id="id6">
<div><a class="reference internal image-reference" href="../_images/blockdiag-16ef5cdf3d8a6a4300fe1484c9349582a144d8c0.png"><img height="120.0" src="../_images/blockdiag-16ef5cdf3d8a6a4300fe1484c9349582a144d8c0.png" width="832.0" /></a></div><p class="caption"><span class="caption-text">ESP-IDF Build System Process</span><a class="headerlink" href="#id6" title="Permalink to this image">¶</a></p>
</div>
<div class="section" id="initialization">
<h4>Initialization<a class="headerlink" href="#initialization" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><p>This phase sets up necessary parameters for the build.</p>
<blockquote>
<div><ul class="simple">
<li><dl class="first docutils">
<dt>Upon inclusion of <code class="docutils literal notranslate"><span class="pre">idf.cmake</span></code> in <code class="docutils literal notranslate"><span class="pre">project.cmake</span></code>, the following steps are performed:</dt>
<dd><ul class="first last">
<li>Set <code class="docutils literal notranslate"><span class="pre">IDF_PATH</span></code> from environment variable or inferred from path to <code class="docutils literal notranslate"><span class="pre">project.cmake</span></code> included in the top-level CMakeLists.txt.</li>
<li>Add <a class="reference external" href="https://github.com/espressif/esp-idf/tree/f91080637//tools/cmake">/tools/cmake</a> to <code class="docutils literal notranslate"><span class="pre">CMAKE_MODULE_PATH</span></code> and include core modules plus the various helper/third-party scripts.</li>
<li>Set build tools/executables such as default Python interpreter.</li>
<li>Get ESP-IDF git revision and store as <code class="docutils literal notranslate"><span class="pre">IDF_VER</span></code>.</li>
<li>Set global build specifications i.e. compile options, compile definitions, include directories for all components in the build.</li>
<li>Add components in <a class="reference external" href="https://github.com/espressif/esp-idf/tree/f91080637/components">components</a> to the build.</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>The initial part of the custom <code class="docutils literal notranslate"><span class="pre">project()</span></code> command performs the following steps:</dt>
<dd><ul class="first last">
<li>Set <code class="docutils literal notranslate"><span class="pre">IDF_TARGET</span></code> from environment variable or CMake cache and the corresponding <code class="docutils literal notranslate"><span class="pre">CMAKE_TOOLCHAIN_FILE</span></code> to be used.</li>
<li>Add components in <code class="docutils literal notranslate"><span class="pre">EXTRA_COMPONENTS_DIRS</span></code> to the build.</li>
<li>Prepare arguments for calling command <code class="docutils literal notranslate"><span class="pre">idf_build_process()</span></code> from variables such as <code class="docutils literal notranslate"><span class="pre">COMPONENTS</span></code>/<code class="docutils literal notranslate"><span class="pre">EXCLUDE_COMPONENTS</span></code>, <code class="docutils literal notranslate"><span class="pre">SDKCONFIG</span></code>, <code class="docutils literal notranslate"><span class="pre">SDKCONFIG_DEFAULTS</span></code>.</li>
</ul>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<p>The call to <code class="docutils literal notranslate"><span class="pre">idf_build_process()</span></code> command marks the end of this phase.</p>
</div></blockquote>
</div>
<div class="section" id="enumeration">
<h4>Enumeration<a class="headerlink" href="#enumeration" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><p>This phase builds a final list of components to be processed in the build, and is performed in the first half of <code class="docutils literal notranslate"><span class="pre">idf_build_process()</span></code>.</p>
<blockquote>
<div><ul class="simple">
<li>Retrieve each component’s public and private requirements. A child process is created which executes each component’s CMakeLists.txt in script mode. The values of <code class="docutils literal notranslate"><span class="pre">idf_component_register</span></code> REQUIRES and PRIV_REQUIRES argument is returned to the parent build process. This is called early expansion. The variable <code class="docutils literal notranslate"><span class="pre">CMAKE_BUILD_EARLY_EXPANSION</span></code> is defined during this step.</li>
<li>Recursively include components based on public and private requirements.</li>
</ul>
</div></blockquote>
</div></blockquote>
</div>
<div class="section" id="processing">
<h4>Processing<a class="headerlink" href="#processing" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><p>This phase processes the components in the build, and is the second half of <code class="docutils literal notranslate"><span class="pre">idf_build_process()</span></code>.</p>
<ul class="simple">
<li>Load project configuration from sdkconfig file and generate an sdkconfig.cmake and sdkconfig.h header. These define configuration variables/macros that are accessible from the build scripts and C/C++ source/header files, respectively.</li>
<li>Include each component’s <code class="docutils literal notranslate"><span class="pre">project_include.cmake</span></code>.</li>
<li>Add each component as a subdirectory, processing its CMakeLists.txt. The component CMakeLists.txt calls the registration command, <code class="docutils literal notranslate"><span class="pre">idf_component_register</span></code> which adds source files, include directories, creates component library, links dependencies, etc.</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="finalization">
<h4>Finalization<a class="headerlink" href="#finalization" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><p>This phase is everything after <code class="docutils literal notranslate"><span class="pre">idf_build_process()</span></code>.</p>
<ul class="simple">
<li>Create executable and link the component libraries to it.</li>
<li>Generate project metadata files such as project_description.json and display relevant information about the project built.</li>
</ul>
</div></blockquote>
<p>Browse <a class="reference external" href="https://github.com/espressif/esp-idf/blob/f91080637//tools/cmake/project.cmake">/tools/cmake/project.cmake</a> for more details.</p>
</div>
</div>
</div>
<div class="section" id="migrating-from-esp-idf-gnu-make-system">
<h2>Migrating from ESP-IDF GNU Make System<a class="headerlink" href="#migrating-from-esp-idf-gnu-make-system" title="Permalink to this headline">¶</a></h2>
<p>Some aspects of the CMake-based ESP-IDF build system are very similar to the older GNU Make-based system. The developer needs to provide values
the include directories, source files etc. There is a syntactical difference, however, as the developer needs to pass these as arguments
to the registration command, <cite>idf_component_register</cite>.</p>
<div class="section" id="automatic-conversion-tool">
<h3>Automatic Conversion Tool<a class="headerlink" href="#automatic-conversion-tool" title="Permalink to this headline">¶</a></h3>
<p>An automatic project conversion tool is available in <a class="reference external" href="https://github.com/espressif/esp-idf/blob/f91080637//tools/cmake/convert_to_cmake.py">/tools/cmake/convert_to_cmake.py</a>. Run this command line tool with the path to a project like this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$IDF_PATH</span>/tools/cmake/convert_to_cmake.py /path/to/project_dir
</pre></div>
</div>
<p>The project directory must contain a Makefile, and GNU Make (<code class="docutils literal notranslate"><span class="pre">make</span></code>) must be installed and available on the PATH.</p>
<p>The tool will convert the project Makefile and any component <code class="docutils literal notranslate"><span class="pre">component.mk</span></code> files to their equivalent <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> files.</p>
<p>It does so by running <code class="docutils literal notranslate"><span class="pre">make</span></code> to expand the ESP-IDF build system variables which are set by the build, and then producing equivalent CMakelists files to set the same variables.</p>
<p>The conversion tool is not capable of dealing with complex Makefile logic or unusual targets. These will need to be converted by hand.</p>
</div>
<div class="section" id="no-longer-available-in-cmake">
<h3>No Longer Available in CMake<a class="headerlink" href="#no-longer-available-in-cmake" title="Permalink to this headline">¶</a></h3>
<p>Some features are significantly different or removed in the CMake-based system. The following variables no longer exist in the CMake-based build system:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">COMPONENT_BUILD_DIR</span></code>: Use <code class="docutils literal notranslate"><span class="pre">CMAKE_CURRENT_BINARY_DIR</span></code> instead.</li>
<li><code class="docutils literal notranslate"><span class="pre">COMPONENT_LIBRARY</span></code>: Defaulted to <code class="docutils literal notranslate"><span class="pre">$(COMPONENT_NAME).a</span></code>, but the library name could be overriden by the component. The name of the component library can no longer be overriden by the component.</li>
<li><code class="docutils literal notranslate"><span class="pre">CC</span></code>, <code class="docutils literal notranslate"><span class="pre">LD</span></code>, <code class="docutils literal notranslate"><span class="pre">AR</span></code>, <code class="docutils literal notranslate"><span class="pre">OBJCOPY</span></code>: Full paths to each tool from the gcc xtensa cross-toolchain. Use <code class="docutils literal notranslate"><span class="pre">CMAKE_C_COMPILER</span></code>, <code class="docutils literal notranslate"><span class="pre">CMAKE_C_LINK_EXECUTABLE</span></code>, <code class="docutils literal notranslate"><span class="pre">CMAKE_OBJCOPY</span></code>, etc instead. <a class="reference external" href="https://cmake.org/cmake/help/v3.5/manual/cmake-variables.7.html#variables-for-languages">Full list here</a>.</li>
<li><code class="docutils literal notranslate"><span class="pre">HOSTCC</span></code>, <code class="docutils literal notranslate"><span class="pre">HOSTLD</span></code>, <code class="docutils literal notranslate"><span class="pre">HOSTAR</span></code>: Full names of each tool from the host native toolchain. These are no longer provided, external projects should detect any required host toolchain manually.</li>
<li><code class="docutils literal notranslate"><span class="pre">COMPONENT_ADD_LDFLAGS</span></code>: Used to override linker flags. Use the CMake <a class="reference external" href="https://cmake.org/cmake/help/v3.5/command/target_link_libraries.html#command:target_link_libraries">target_link_libraries</a> command instead.</li>
<li><code class="docutils literal notranslate"><span class="pre">COMPONENT_ADD_LINKER_DEPS</span></code>: List of files that linking should depend on. <a class="reference external" href="https://cmake.org/cmake/help/v3.5/command/target_link_libraries.html#command:target_link_libraries">target_link_libraries</a> will usually infer these dependencies automatically. For linker scripts, use the provided custom CMake function <code class="docutils literal notranslate"><span class="pre">target_linker_scripts</span></code>.</li>
<li><code class="docutils literal notranslate"><span class="pre">COMPONENT_SUBMODULES</span></code>: No longer used, the build system will automatically enumerate all submodules in the ESP-IDF repository.</li>
<li><code class="docutils literal notranslate"><span class="pre">COMPONENT_EXTRA_INCLUDES</span></code>: Used to be an alternative to <code class="docutils literal notranslate"><span class="pre">COMPONENT_PRIV_INCLUDEDIRS</span></code> for absolute paths. Use <code class="docutils literal notranslate"><span class="pre">PRIV_INCLUDE_DIRS</span></code> argument to <code class="docutils literal notranslate"><span class="pre">idf_component_register</span></code> for all cases now (can be relative or absolute).</li>
<li><code class="docutils literal notranslate"><span class="pre">COMPONENT_OBJS</span></code>: Previously, component sources could be specified as a list of object files. Now they can be specified as a list of source files via <code class="docutils literal notranslate"><span class="pre">SRCS</span></code> argument to <cite>idf_component_register</cite>.</li>
<li><code class="docutils literal notranslate"><span class="pre">COMPONENT_OBJEXCLUDE</span></code>: Has been replaced with <code class="docutils literal notranslate"><span class="pre">EXCLUDE_SRCS</span></code> argument to <code class="docutils literal notranslate"><span class="pre">idf_component_register</span></code>. Specify source files (as absolute paths or relative to component directory), instead.</li>
<li><code class="docutils literal notranslate"><span class="pre">COMPONENT_EXTRA_CLEAN</span></code>: Set property <code class="docutils literal notranslate"><span class="pre">ADDITIONAL_MAKE_CLEAN_FILES</span></code> instead but note <a class="reference internal" href="#additional-make-clean-files-note"><span class="std std-ref">CMake has some restrictions around this functionality</span></a>.</li>
<li><code class="docutils literal notranslate"><span class="pre">COMPONENT_OWNBUILDTARGET</span></code> &amp; <code class="docutils literal notranslate"><span class="pre">COMPONENT_OWNCLEANTARGET</span></code>: Use CMake <a class="reference external" href="https://cmake.org/cmake/help/v3.5/module/ExternalProject.html">ExternalProject</a> instead. See <a class="reference internal" href="#component-build-full-override"><span class="std std-ref">Fully Overriding The Component Build Process</span></a> for full details.</li>
<li><code class="docutils literal notranslate"><span class="pre">COMPONENT_CONFIG_ONLY</span></code>: Call <code class="docutils literal notranslate"><span class="pre">idf_component_register</span></code> without any arguments instead. See <a class="reference internal" href="#configuration-only-components">Configuration-Only Components</a>.</li>
<li><code class="docutils literal notranslate"><span class="pre">CFLAGS</span></code>, <code class="docutils literal notranslate"><span class="pre">CPPFLAGS</span></code>, <code class="docutils literal notranslate"><span class="pre">CXXFLAGS</span></code>: Use equivalent CMake commands instead. See <a class="reference internal" href="#controlling-component-compilation">Controlling Component Compilation</a>.</li>
</ul>
</div>
<div class="section" id="no-default-values">
<h3>No Default Values<a class="headerlink" href="#no-default-values" title="Permalink to this headline">¶</a></h3>
<p>Unlike in the legacy Make-based build system, the following have no default values:</p>
<ul class="simple">
<li>Source directories (<code class="docutils literal notranslate"><span class="pre">COMPONENT_SRCDIRS</span></code> variable in Make, <code class="docutils literal notranslate"><span class="pre">SRC_DIRS</span></code> argument to <code class="docutils literal notranslate"><span class="pre">idf_component_register</span></code> in CMake)</li>
<li>Include directories (<code class="docutils literal notranslate"><span class="pre">COMPONENT_ADD_INCLUDEDIRS</span></code> variable in Make, <code class="docutils literal notranslate"><span class="pre">INCLUDE_DIRS</span></code> argument to <code class="docutils literal notranslate"><span class="pre">idf_component_register</span></code> in CMake)</li>
</ul>
</div>
<div class="section" id="no-longer-necessary">
<h3>No Longer Necessary<a class="headerlink" href="#no-longer-necessary" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>In the legacy Make-based build system, it is required to also set <code class="docutils literal notranslate"><span class="pre">COMPONENT_SRCDIRS</span></code> if <code class="docutils literal notranslate"><span class="pre">COMPONENT_SRCS</span></code> is set. In CMake, the equivalent is not necessary i.e. specifying <code class="docutils literal notranslate"><span class="pre">SRC_DIRS</span></code> to <code class="docutils literal notranslate"><span class="pre">idf_component_register</span></code> if <code class="docutils literal notranslate"><span class="pre">SRCS</span></code> is also specified (in fact, <code class="docutils literal notranslate"><span class="pre">SRCS</span></code> is ignored if <code class="docutils literal notranslate"><span class="pre">SRC_DIRS</span></code> is specified).</li>
</ul>
</div>
<div class="section" id="flashing-from-make">
<h3>Flashing from make<a class="headerlink" href="#flashing-from-make" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">flash</span></code> and similar targets still work to build and flash. However, project <code class="docutils literal notranslate"><span class="pre">sdkconfig</span></code> no longer specifies serial port and baud rate. Environment variables can be used to override these. See <a class="reference internal" href="#flash-with-ninja-or-make"><span class="std std-ref">Flashing with ninja or make</span></a> for more details.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="build-system-legacy.html" class="btn btn-neutral float-right" title="Build System (Legacy GNU Make)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="bootloader.html" class="btn btn-neutral float-left" title="Bootloader" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016 - 2019, Espressif Systems (Shanghai) CO., LTD
      
        <span class="commit">
          Revision <code>f9108063</code>.
        </span>
      

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org/">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      v: latest
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Versions</dt>
        
          <dd><a href="https://docs.espressif.com/en/latest/">latest</a></dd>
        
          <dd><a href="https://docs.espressif.com/en/stable/">stable</a></dd>
        
          <dd><a href="https://docs.espressif.com/en/v4.0-rc/">v4.0-rc</a></dd>
        
          <dd><a href="https://docs.espressif.com/en/v4.0-beta2/">v4.0-beta2</a></dd>
        
          <dd><a href="https://docs.espressif.com/en/v3.3.1/">v3.3.1</a></dd>
        
          <dd><a href="https://docs.espressif.com/en/v3.3/">v3.3</a></dd>
        
          <dd><a href="https://docs.espressif.com/en/v3.2.3/">v3.2.3</a></dd>
        
          <dd><a href="https://docs.espressif.com/en/v3.2.2/">v3.2.2</a></dd>
        
          <dd><a href="https://docs.espressif.com/en/v3.1.6/">v3.1.6</a></dd>
        
          <dd><a href="https://docs.espressif.com/en/v3.1.5/">v3.1.5</a></dd>
        
          <dd><a href="https://docs.espressif.com/en/v3.0.9/">v3.0.9</a></dd>
        
          <dd><a href="https://docs.espressif.com/en/release-v4.1/">release-v4.1</a></dd>
        
          <dd><a href="https://docs.espressif.com/en/release-v4.0/">release-v4.0</a></dd>
        
          <dd><a href="https://docs.espressif.com/en/release-v3.3/">release-v3.3</a></dd>
        
          <dd><a href="https://docs.espressif.com/en/release-v3.2/">release-v3.2</a></dd>
        
          <dd><a href="https://docs.espressif.com/en/release-v3.1/">release-v3.1</a></dd>
        
          <dd><a href="https://docs.espressif.com/en/release-v3.0/">release-v3.0</a></dd>
        
      </dl>
      <dl>
        <dt>Downloads</dt>
        
          <dd><a href="http://docs.espressif.com/_/downloads/esp-idf/en/latest/pdf/">pdf</a></dd>
        
      </dl>
      <dl>
        <dt>On Read the Docs</dt>
          <dd>
            <a href="http://readthedocs.com/projects/espressif-esp-idf/?fromdocs=espressif-esp-idf">Project Home</a>
          </dd>
          <dd>
            <a href="http://readthedocs.com/builds/espressif-esp-idf/?fromdocs=espressif-esp-idf">Builds</a>
          </dd>
      </dl>
      <hr/>
      Free document hosting provided by <a href="http://www.readthedocs.org/">Read the Docs</a>.

    </div>
  </div>



  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
   

</body>

<!-- Mirrored from docs.espressif.com/projects/esp-idf/en/latest/api-guides/build-system.html by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 29 Feb 2020 06:27:15 GMT -->
</html>